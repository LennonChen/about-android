<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn"><head><script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/gpt.js" type="text/javascript" async=""></script><script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/encoder.js" type="text/javascript"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Android之 MTP框架和流程分析 - 如果天空不死 - 博客园</title>
<link type="text/css" rel="stylesheet" href="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/blog-common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/style.css">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/skywang12345/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/skywang12345/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/skywang12345/wlwmanifest.xml">
<script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'skywang12345', cb_enable_mathjax=false;</script>
<script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/blog-common.js" type="text/javascript"></script>
<script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/pubads_impl_39.js" type="text/javascript" async=""></script><script src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/osd.js" type="text/javascript"></script></head>
<body>
<a name="top"></a>

<div class="pagelayout">
    
<div class="header">
	<div>
		<a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/skywang12345/">skywang12345</a>
	</div>
	<div>
		
	</div>
</div>
    <div id="leftmenu" class="leftcolumn">
        
            
<h1 class="listtitle">导航</h1>
<ul class="list">
			<li class="listitem"><a id="MyLinks1_HomeLink" class="listitem" href="http://www.cnblogs.com/">博客园</a></li>
			<li class="listitem"><a id="MyLinks1_MyHomeLink" href="http://www.cnblogs.com/skywang12345/">首页</a>
			</li><li class="listitem"><a id="MyLinks1_NewPostLink" rel="nofollow" href="http://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a>
			</li><li class="listitem"><a id="MyLinks1_ContactLink" accesskey="9" class="listitem" rel="nofollow" href="http://space.cnblogs.com/msg/send/%e5%a6%82%e6%9e%9c%e5%a4%a9%e7%a9%ba%e4%b8%8d%e6%ad%bb">联系</a></li>
			<li class="listitem"><a id="MyLinks1_Syndication" class="listitem" href="http://www.cnblogs.com/skywang12345/rss">订阅</a><a id="MyLinks1_XMLLink" href="http://www.cnblogs.com/skywang12345/rss"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/xml.gif" alt="订阅"></a>
			</li><li class="listitem"><a id="MyLinks1_Admin" class="listitem" rel="nofollow" href="http://i.cnblogs.com/">管理</a></li>
</ul>
            <div id="blog-calendar" style=""><table id="blogCalendar" class="Cal" title="日历" cellpadding="0" cellspacing="0">
	<tbody><tr><td colspan="7"><table class="CalTitle" cellspacing="0">
		<tbody><tr><td class="CalNextPrev"><a href="javascript:void(0);" onclick="loadBlogCalendar('2014/04/01');return false;">&lt;</a></td><td align="center">2014年5月</td><td class="CalNextPrev" align="right"><a href="javascript:void(0);" onclick="loadBlogCalendar('2014/06/01');return false;">&gt;</a></td></tr>
	</tbody></table></td></tr><tr><th class="CalDayHeader" abbr="日" scope="col" align="center">日</th><th class="CalDayHeader" abbr="一" scope="col" align="center">一</th><th class="CalDayHeader" abbr="二" scope="col" align="center">二</th><th class="CalDayHeader" abbr="三" scope="col" align="center">三</th><th class="CalDayHeader" abbr="四" scope="col" align="center">四</th><th class="CalDayHeader" abbr="五" scope="col" align="center">五</th><th class="CalDayHeader" abbr="六" scope="col" align="center">六</th></tr><tr><td class="CalOtherMonthDay" align="center">27</td><td class="CalOtherMonthDay" align="center">28</td><td class="CalOtherMonthDay" align="center">29</td><td class="CalOtherMonthDay" align="center">30</td><td align="center">1</td><td align="center">2</td><td class="CalWeekendDay" align="center">3</td></tr><tr><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/04.html"><u>4</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/05.html"><u>5</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/06.html"><u>6</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/07.html"><u>7</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/08.html"><u>8</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/09.html"><u>9</u></a></td><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/10.html"><u>10</u></a></td></tr><tr><td class="CalWeekendDay" align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/11.html"><u>11</u></a></td><td align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/12.html"><u>12</u></a></td><td class="CalTodayDay" align="center"><a href="http://www.cnblogs.com/skywang12345/archive/2014/05/13.html"><u>13</u></a></td><td align="center">14</td><td align="center">15</td><td align="center">16</td><td class="CalWeekendDay" align="center">17</td></tr><tr><td class="CalWeekendDay" align="center">18</td><td align="center">19</td><td align="center">20</td><td align="center">21</td><td align="center">22</td><td align="center">23</td><td class="CalWeekendDay" align="center">24</td></tr><tr><td class="CalWeekendDay" align="center">25</td><td align="center">26</td><td align="center">27</td><td align="center">28</td><td align="center">29</td><td align="center">30</td><td class="CalWeekendDay" align="center">31</td></tr><tr><td class="CalOtherMonthDay" align="center">1</td><td class="CalOtherMonthDay" align="center">2</td><td class="CalOtherMonthDay" align="center">3</td><td class="CalOtherMonthDay" align="center">4</td><td class="CalOtherMonthDay" align="center">5</td><td class="CalOtherMonthDay" align="center">6</td><td class="CalOtherMonthDay" align="center">7</td></tr>
</tbody></table></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
            
<div class="listtitle">统计</div>
	<ul class="list">
		<li class="listitem">随笔 - 262
		</li><li class="listitem">文章 - 0
		</li><li class="listitem">评论 - 223
		</li><li class="listitem">引用 - 0
	</li>
</ul>
            
            <div id="blog-sidecolumn">

<div class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="widget_my_zzk" class="div_my_zzk"><input id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk" type="text">&nbsp;<input onclick="zzk_go()" value="找找看" id="btnZzk" class="btn_my_zzk" type="button"></div>

</div>


<h3 class="catListTitle">常用链接</h3>
<ul>

		<li><a id="ctl01_rptMainLinks_lnkLinkItem_0" href="http://www.cnblogs.com/skywang12345/p/">我的随笔</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_1" href="http://www.cnblogs.com/skywang12345/MyComments.html">我的评论</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_2" title="我发表过评论的随笔" href="http://www.cnblogs.com/skywang12345/OtherPosts.html">我的参与</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_3" href="http://www.cnblogs.com/skywang12345/RecentComments.html">最新评论</a></li>
	
		<li><a id="ctl01_rptMainLinks_lnkLinkItem_4" href="http://www.cnblogs.com/skywang12345/tag/">我的标签</a></li>
	
</ul>
<div id="itemListLin_con" style="display:none;">

</div>
		<h1 class="listtitle">随笔分类<span style="font-size:11px;font-weight:normal">(281)</span></h1>
		
				<ul class="list">
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_0" class="listitem" href="http://www.cnblogs.com/skywang12345/category/493848.html">Android(7)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_1" class="listitem" href="http://www.cnblogs.com/skywang12345/category/482610.html">Android NDK编程(9)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_2" class="listitem" href="http://www.cnblogs.com/skywang12345/category/490118.html">Android 系统层(6)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_3" class="listitem" href="http://www.cnblogs.com/skywang12345/category/455318.html">Android 应用层(47)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_4" class="listitem" href="http://www.cnblogs.com/skywang12345/category/476579.html">Computer Culture(2)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_5" class="listitem" href="http://www.cnblogs.com/skywang12345/category/455711.html">Java(111)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_6" class="listitem" href="http://www.cnblogs.com/skywang12345/category/481789.html">Linux/Ubuntu(5)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_7" class="listitem" href="http://www.cnblogs.com/skywang12345/category/548620.html">UML(5)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_8" class="listitem" href="http://www.cnblogs.com/skywang12345/category/540303.html">Windows(1)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_9" class="listitem" href="http://www.cnblogs.com/skywang12345/category/548777.html">设计模式(20)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_10" class="listitem" href="http://www.cnblogs.com/skywang12345/category/508186.html">数据结构_算法(64)</a>  </li>
			
				<li class="listitem"><a id="ctl02_CatList_LinkList_0_Link_11" class="listitem" href="http://www.cnblogs.com/skywang12345/category/489072.html">索引(4)</a>  </li>
			
				</ul>
			
	

<h3 class="catListTitle">最新评论</h3>
<div class="RecentComment" id="RecentComments">
	<div id="RecentCommentsBlock"><ul>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/skywang12345/p/3707621.html#2937226">1. Re:邻接表有向图(一)之 C语言详解</a></li>
    <li class="recent_comment_body">好复杂啊</li>
    <li class="recent_comment_author">--岁月漫步</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/skywang12345/p/3323085.html#2937088">2. Re:Java 集合系列目录(Category)</a></li>
    <li class="recent_comment_body">mark</li>
    <li class="recent_comment_author">--宁静的天空</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/skywang12345/p/3707607.html#2935773">3. Re:邻接表无向图(一)之 C语言详解</a></li>
    <li class="recent_comment_body">楼主是要三种语言通杀吗？<br>请问如何做的，请教学习经验。谢谢</li>
    <li class="recent_comment_author">--Chris_Fu</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/skywang12345/p/3706833.html#2935299">4. Re:哈夫曼树(三)之 Java详解</a></li>
    <li class="recent_comment_body"><a href="#2935041" title="查看所回复的评论" onclick="commentManager.renderComments(0,50,2935041);">@</a>Dont<br>嗯，你是对的。<br>谢谢指出，原文已更正。</li>
    <li class="recent_comment_author">--如果天空不死</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/skywang12345/p/3707610.html#2935296">5. Re:邻接表无向图(二)之 C++详解</a></li>
    <li class="recent_comment_body">@辉_辉嗯，后面讲解"最小生成树"以及"最短路径算法"时，才涉及到权值。那时候再给出支持"权值"的代码。...</li>
    <li class="recent_comment_author">--如果天空不死</li>
</ul>
</div>
</div>

<h3 class="catListTitle">阅读排行榜</h3>
<div class="RecentComment" id="TopViewPosts"> 
	<div id="TopViewPostsBlock"><ul><li><a href="http://www.cnblogs.com/skywang12345/p/3158310.html">1. Android 之窗口小部件详解--App Widget(4389)</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3154150.html">2. Android 布局之GridLayout(4120)</a></li><li><a href="http://www.cnblogs.com/skywang12345/archive/2013/06/15/AndroidAttr.html">3. Android layout属性详细说明(3989)</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3323085.html">4. Java 集合系列目录(Category)(3671)</a></li><li><a href="http://www.cnblogs.com/skywang12345/p/3160260.html">5. Android App组件之ListFragment -- 说明和示例(2973)</a></li></ul></div>
</div>
</div><script type="text/javascript">loadBlogSideColumn();</script>
        
        <div class="spacer">
            &nbsp;</div>
    </div>
    <div class="centercolumn">
        

<div class="singlepost">
	<div class="posttitle">
		<a id="cb_post_title_url" class="singleposttitle" href="http://www.cnblogs.com/skywang12345/p/3474206.html">Android之 MTP框架和流程分析</a>
	</div>
    <div class="postbody">
	<div id="cnblogs_post_body"><p>&nbsp;</p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;">概要</span></h3>
<p><span style="font-size: 14px;">本文的目的是介绍Android系统中MTP的一些相关知识。主要的内容包括：</span><br><a href="#part1"><strong><span style="font-size: 14px;">第1部分 MTP简介</span></strong></a><br><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 对Mtp协议进行简单的介绍。</span><br><a href="#part2"><strong><span style="font-size: 14px;">第2部分 MTP框架</span></strong></a><br><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 介绍Android系统下MTP的框架。</span><br><a href="#part3"><strong><span style="font-size: 14px;">第3部分 MTP启动流程</span></strong></a><br><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 详细分析MTP服务的启动流程，包括Java层, JNI层, kernel相关知识的介绍。</span><br><a href="#part4"><strong><span style="font-size: 14px;">第4部分 MTP协议之I-&gt;R流程</span></strong></a><br><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 以"PC中打开一个MTP上的文件(读取文件内容)"为例，来对"MTP协议中Initiator到Reponser的流程"进行说明。</span><br><a href="#part5"><strong><span style="font-size: 14px;">第5部分 MTP协议之R-&gt;I流程</span></strong></a><br><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 以"Android设备中将一个文件拷贝到其他目录"来对"MTP协议中Reponser到Initiator的流程"进行说明。</span><br><span style="font-size: 14px; color: #ff0000;">注意：本文的MTP分析的软件环境Android 4.3 + Kernel 3.0！</span></p>
<p><span style="font-size: 14px;"><strong>转载请注明出处：</strong><span style="color: #0000ff;"><strong><a href="http://www.cnblogs.com/skywang12345/p/3474206.html"><span style="color: #0000ff;">http://www.cnblogs.com/skywang12345/p/3474206.html</span></a></strong></span></span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;"><a name="part1"></a>第1部分 MTP简介</span></h3>
<p><span style="font-size: 14px;">MTP，全称是Media Transfer Protocol（媒体传输协议）。它是微软的一个为计算机和便携式设备之间传输图像、音乐等所定制的协议。</span></p>
<p><span style="font-size: 14px;">Android从3.0开始支持MTP。MTP的应用分两种角色，一个是作为Initiator，另一个作为Responder。以"Android平板电脑"连接"PC"为例，他们的关系如图1-01所示。</span></p>
<p><span style="font-family: 楷体; font-size: 14px;"><span style="color: #0070c0;"><strong>Initiator </strong></span>—— 在MTP中所有的请求都有Initiator发起。例如，PC请求获取Android平板电脑上的文件数据。 </span></p>
<p><span style="font-family: 楷体; font-size: 14px;"><span style="color: #0070c0;"><strong>Responder </strong></span>—— 它会处理Initiator的请求；除此之外，Responder也会发送Event事件。 </span></p>
<p style="text-align: center;"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135923-270a5d682d584e4884adc9a25974e82e.jpg" alt=""></span></p>
<p style="text-align: center;"><span style="font-size: 14px;">图1-01</span></p>
<p style="text-align: left;"><span style="font-size: 14px; color: #ff0000;">注意：关于MTP的详细规格请参考《<a href="http://files.cnblogs.com/skywang12345/mtp_specification_v1.0.pdf" target="_blank"><strong>MTP_Specification_V1.0</strong></a>》！</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;"><a name="part2"></a>第2部分 MTP框架</span></h3>
<p><span style="font-size: 14px;">Android中MTP的框架如图2-01所示：</span></p>
<p style="text-align: center;"><a href="http://images.cnitblog.com/blog/497634/201312/14135924-7cb862a3be0241a3ae34e2a82c4868c3.jpg" target="_blank"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135924-7cb862a3be0241a3ae34e2a82c4868c3.jpg" alt="" height="536" width="540"></span></a></p>
<p style="text-align: center;"><span style="font-size: 14px;">图2-01</span></p>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; 在<span style="color: #0070c0;"><strong>Kernel</strong></span>层，<span style="color: #0070c0;"><strong>USB驱动</strong></span>负责数据交换，而<span style="color: #0070c0;"><strong>MTP驱动</strong></span>负责和上层进行通信，同时也和USB驱动进行通信。</span></p>
<p><span style="font-size: 14px;">(01)USB驱动负责数据交换，是指Android设备和PC通过USB数据线连接之后，实际的数据交换是经过USB数据线发送给USB驱动的。</span></p>
<p><span style="font-size: 14px;">(02)对于"MTP请求"而言，MTP驱动会从USB驱动中解析出的MTP请求数据，然后传递给上层。而对于上层传来的"MTP反馈"，MTP驱动也会将反馈内容打包好之后，通过传递给USB驱动。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; 在<span style="color: #0070c0;"><strong>JNI</strong></span>层，<span style="color: #0070c0;"><strong>MtpServer</strong></span>会不断地监听Kernel的消息"MTP请求"，并对相应的消息进行相关处理。同时，MTP的Event事件也是通过MtpServer发送给MTP驱动的。 <span style="color: #0070c0;"><strong>MtpStorage</strong></span>对应一个"存储单元"；例如，SD卡就对应一个MtpStorage。 <span style="color: #0070c0;"><strong>MtpPacket</strong></span>和<span style="color: #0070c0;"><strong>MtpEventPacket</strong></span>负
责对MTP消息进行打包。android_mtp_MtpServer是一个JNI类，它是"JNI层的MtpServer 和 
Java层的MtpServer"沟通的桥梁。android_mtp_MtpDatabase也是一个JNI类，JNI层通过它实现了对
MtpDatabase(Framework层)的操作。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; 在<span style="color: #0070c0;"><strong>Framework</strong></span>层，<span style="color: #0070c0;"><strong>MtpServer</strong></span>相
当于一个服务器，它通过和底层进行通信从而提供了MTP的相关服务。MtpDatabase充当着数据库的功能，但它本身并没有数据库对数据进行保存，本
质上是通过MediaProvider数据库获取所需要的数据。MtpStorage对应一个"存储单元"，它和"JNI层的MtpStorage"相对
应。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; 在<span style="color: #0070c0;"><strong>Application</strong></span>层，<span style="color: #0070c0;"><strong>MtpReceiver</strong></span>负责接收广播，接收到广播后会启动/关闭MtpService；例如，MtpReceiver收到"Android设备 和 PC连上"的消息时，会启动MtpService。 <span style="color: #0070c0;"><strong>MtpService</strong></span>的作用是提供管理MTP的服务，它会启动MtpServer，以及将本地存储内容和MTP的内容同步。 <span style="color: #0070c0;"><strong>MediaProvider</strong></span>在MTP中的角色，是本地存储内容查找和本地内容同步；例如，本地新增一个文件时，MediaProvider会通知MtpServer从而进行MTP数据同步。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;"><a name="part3"></a>第3部分 MTP启动流程</span></h3>
<p><span style="font-family: 楷体; font-size: 14px;">该部分对MTP服务的启动流程进行详细介绍。我们先通过时序图对MTP启动流程有个整体印象，然后再通过代码进行详细分析。其中，涉及的内容，包括Java层、JNI层和Kernel。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">MTP服务启动时，Java层的程序流程如下图3-01所示。</span></p>
<p style="text-align: center;"><a href="http://images.cnitblog.com/blog/497634/201312/14135925-b331dccb650f444c9b41f47b57a53cc2.jpg" target="_blank"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135925-b331dccb650f444c9b41f47b57a53cc2.jpg" alt="" height="409" width="760"></span></a></p>
<p style="text-align: center;"><span style="font-size: 14px;">图3-01</span></p>
<p><span style="font-size: 14px;"><strong>说明</strong>：MTP服务启动的触发事件是"<span style="color: #0070c0;"><strong>PC和Android设备建立MTP连接</strong></span>"。当她们建立MTP连接时，<span style="color: #0070c0;"><strong>USB驱动</strong></span>将产生USB连接消息，并最终通知<span style="color: #0070c0;"><strong>UsbManager</strong></span>。<span style="color: #0070c0;"><strong>UsbManager</strong></span>发出广播，并且广播被<span style="color: #0070c0;"><strong>MtpReceiver</strong></span>收到；<span style="color: #0070c0;"><strong>MtpReceiver</strong></span>收到广播后会启动<span style="color: #0070c0;"><strong>MtpService</strong></span>，同时通知<span style="color: #0070c0;"><strong>MediaProvider</strong></span>。<span style="color: #0070c0;"><strong>MediaProvider</strong></span>会与<span style="color: #0070c0;"><strong>MtpService</strong></span>绑定，若Android设备中的文件结构有变化(如"新键文件")，<span style="color: #0070c0;"><strong>MediaProvider</strong></span>则会通知<span style="color: #0070c0;"><strong>MtpService</strong></span>。<span style="color: #0070c0;"><strong>MtpService</strong></span>启动后会创建<span style="color: #0070c0;"><strong>MtpDatabase</strong></span>；之后，还会创建<span style="color: #0070c0;"><strong>MtpServer</strong></span>，<span style="color: #0070c0;"><strong>MtpServer</strong></span>会和<span style="color: #0070c0;"><strong>MtpDatabase</strong></span>关联。然后，<span style="color: #0070c0;"><strong>MtpService</strong></span>会遍历本地的存储设备，并建立相应的<span style="color: #0070c0;"><strong>MtpStorage</strong></span>，并将该<span style="color: #0070c0;"><strong>MtpStorage</strong></span>添加到<span style="color: #0070c0;"><strong>MtpDatabase</strong></span>和<span style="color: #0070c0;"><strong>MtpServer</strong></span>中。最后，<span style="color: #0070c0;"><strong>MtpService</strong></span>会启动<span style="color: #0070c0;"><strong>MtpServer</strong></span>。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">MTP服务启动时，JNI层的程序流程如下图3-02所示。</span></p>
<p style="text-align: center;"><a href="http://images.cnitblog.com/blog/497634/201312/14135926-30760b9ef7014b5aa844a456262355b2.jpg" target="_blank"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135926-30760b9ef7014b5aa844a456262355b2.jpg" alt="" height="324" width="770"></span></a></p>
<p style="text-align: center;"><span style="font-size: 14px;">图3-02</span></p>
<p><span style="font-size: 14px;"><strong>说明</strong>： 前面说过MtpService启动后会先后创建MtpDatabase对象和MtpServer对象(Java层)，然后启动MtpServer(Java层)。</span></p>
<p><span style="font-size: 14px;">在创建<span style="color: #0070c0;"><strong>MtpDatabase</strong></span>对象时，会通过<span style="color: #0070c0;"><strong>native_setup</strong></span>()调用JNI本地方法。目的是进行初始化，为后面的MtpServer调用做准备。</span></p>
<p><span style="font-size: 14px;">在创建<span style="color: #0070c0;"><strong>MtpServer对象(Java层)</strong></span>时，会通过<span style="color: #0070c0;"><strong>native_setup()</strong></span>调用JNI本地方法。在本地方法中，打开MTP驱动创建的文件节点"<span style="color: #0070c0;"><strong>/dev/mtp_usb</strong></span>"，并会获取<span style="color: #0070c0;"><strong>MyMtpDatabase</strong></span>对象，然后创建"<span style="color: #0070c0;"><strong>MtpServer对象(JNI层)</strong></span>"。</span></p>
<p><span style="font-size: 14px;">在启动<span style="color: #0070c0;"><strong>MtpServer</strong></span>线程时，会对应的执行<span style="color: #0070c0;"><strong>MtpServer(JNI层)</strong></span>的run()方法。<span style="color: #0070c0;"><strong>MtpServer(JNI层)</strong></span>的run()中会不断的从"/dev/mtp_usb"中读取数据，并进行相应的处理。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">涉及到的主要文件的路径：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>packages/providers/MediaProvider/src/com/android/providers/media/<span style="color: #000000;">MtpReceiver.java
packages</span>/providers/MediaProvider/src/com/android/providers/media/<span style="color: #000000;">MtpService.java
packages</span>/providers/MediaProvider/src/com/android/providers/media/<span style="color: #000000;">MediaProvider.java
frameworks</span>/base/media/java/android/mtp/<span style="color: #000000;">MtpServer.java
frameworks</span>/base/media/java/android/mtp/<span style="color: #000000;">MtpDatabase.java
frameworks</span>/base/media/java/android/mtp/<span style="color: #000000;">MtpStorage.java
frameworks</span>/base/media/jni/<span style="color: #000000;">android_mtp_MtpServer.cpp
frameworks</span>/base/media/jni/<span style="color: #000000;">android_mtp_MtpDatabase.cpp
frameworks</span>/av/media/mtp/<span style="color: #000000;">MtpServer.h
frameworks</span>/av/media/mtp/<span style="color: #000000;">MtpServer.cpp
frameworks</span>/av/media/mtp/MtpDatabase.h</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p><span style="font-size: 14px;">接下来，通过代码对MTP的服务启动的各个流程进行分析</span></p>
<h1><span style="font-size: 14px;">1 USB_STATE广播</span></h1>
<p><span style="font-size: 14px;">USB_STATE广播，即"android.hardware.usb.action.USB_STATE"广播。它是在USB连上/断开时，由UsbManager发出的广播；MtpReceive会接收该广播并进行处理。</span></p>
<p><span style="font-size: 14px;">例如，当"Android设备"和"PC"通过USB连接时，MtpReceiver会接收到USB_STATE广播，并判断"USB是不是连上，MTP是不是Enable状态"从而决定是否启动MtpService。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">1.1 MtpReceiver监听广播的注册</span></h2>
<p><span style="font-size: 14px;">MtpReceiver.java在它对应的manifest中注册监听"android.intent.action.BOOT_COMPLETED" 和 "android.hardware.usb.action.USB_STATE" 监听。</span></p>
<p><span style="font-size: 14px;">packages/providers/MediaProvider/AndroidManifest.xml中的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">receiver </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">=".MtpReceiver"</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">2</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">3</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">="android.intent.action.BOOT_COMPLETED"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;">4</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">5</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">6</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">action </span><span style="color: #ff0000;">android:name</span><span style="color: #0000ff;">="android.hardware.usb.action.USB_STATE"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #008080;">7</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">intent-filter</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #008080;">8</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">receiver</span><span style="color: #0000ff;">&gt;</span></pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">这是采用静态方式注册的广播，经过上面的注册之后，MtpReceiver就可以接收"android.intent.action.BOOT_COMPLETED" 和 "android.hardware.usb.action.USB_STATE" 这两个广播了。</span></p>
<p><span style="font-size: 14px;">(01) "android.intent.action.BOOT_COMPLETED" -- 是Android设备开机完成后发出的广播。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; MtpReceiver通过该广播，来处理开机时Android设备和PC就已经是连接状态的情况。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp; 该字符串对应是frameworks/base/core/java/android/content/Intent.java中的ACTION_BOOT_COMPLETED变量，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String ACTION_BOOT_COMPLETED = "android.intent.action.BOOT_COMPLETED";</pre>
</div>
<p><span style="font-size: 14px;">(02) "android.hardware.usb.action.USB_STATE" -- 是USB连接状态发生变化时产生的广播。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp;MtpReceiver通过该广播，来处理Android设备和PC之间通过USB线热插拔的情况。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp;该字符串对应是frameworks/base/core/java/android/hardware/usb/UsbManager.java中的ACTION_USB_STATE变量，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String ACTION_USB_STATE = "android.hardware.usb.action.USB_STATE";</pre>
</div>
<p><span style="line-height: 1.5;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">1.2 MtpReceiver对广播的处理</span></h2>
<p><span style="font-size: 14px;">MtpReceiver对广播的处理在MtpReceiver.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onReceive(Context context, Intent intent) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">final</span> String action =<span style="color: #000000;"> intent.getAction();
</span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (Intent.ACTION_BOOT_COMPLETED.equals(action)) {
</span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">final</span> Intent usbState =<span style="color: #000000;"> context.registerReceiver(
</span><span style="color: #008080;"> 5</span>                 <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">new</span><span style="color: #000000;"> IntentFilter(UsbManager.ACTION_USB_STATE));
</span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">if</span> (usbState != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">            handleUsbState(context, usbState);
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        }
</span><span style="color: #008080;"> 9</span>     } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (UsbManager.ACTION_USB_STATE.equals(action)) {
</span><span style="color: #008080;">10</span> <span style="color: #000000;">        handleUsbState(context, intent);
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">12</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">MtpReceiver的onReceive()中会处理Intent.ACTION_BOOT_COMPLETED 和 UsbManager.ACTION_USB_STATE 这两个广播。</span></p>
<p><span style="font-size: 14px;">Intent.ACTION_BOOT_COMPLETED 和 
UsbManager.ACTION_USB_STATE 
的处理流程一样，最终都是通过handleUsbState()来处理的。下面的是基于UsbManager.ACTION_USB_STATE广播。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-family: 楷体; font-size: 14px;"> 当"Android设备"和"PC"连接时，Android系统会检测USB连接事件并发出UsbManager.ACTION_USB_STATE广播。MtpReceiver最终会调用handleUsbState()对该广播进行处理。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">1.3 MtpReceiver的handleUsbState()</span></h2>
<p><span style="font-size: 14px;">handleUsbState()也在MtpReceiver.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleUsbState(Context context, Intent intent) {
</span><span style="color: #008080;"> 2</span>     Bundle extras =<span style="color: #000000;"> intent.getExtras();
</span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">boolean</span> connected = extras.getBoolean(UsbManager.USB_CONFIGURED);    <span style="color: #008000;">//</span><span style="color: #008000;"> 获取USB的连接状态</span>
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">boolean</span> mtpEnabled = extras.getBoolean(UsbManager.USB_FUNCTION_MTP); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取MTP的Enable状态</span>
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">boolean</span> ptpEnabled = extras.getBoolean(UsbManager.USB_FUNCTION_PTP); <span style="color: #008000;">//</span><span style="color: #008000;"> 获取PTP的Enable状态</span>
<span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span> (connected &amp;&amp; (mtpEnabled ||<span style="color: #000000;"> ptpEnabled)) {
</span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果USB是连接状态，并且“MTP或者PTP是Enable状态”就执行下面的代码</span>
<span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span>         intent = <span style="color: #0000ff;">new</span> Intent(context, MtpService.<span style="color: #0000ff;">class</span><span style="color: #000000;">);
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (ptpEnabled) {
</span><span style="color: #008080;">12</span>             intent.putExtra(UsbManager.USB_FUNCTION_PTP, <span style="color: #0000ff;">true</span><span style="color: #000000;">);
</span><span style="color: #008080;">13</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 启动MtpService服务</span>
<span style="color: #008080;">15</span> <span style="color: #000000;">        context.startService(intent);
</span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 通知MediaProvider，MTP已经连上。</span>
<span style="color: #008080;">17</span> <span style="color: #000000;">        context.getContentResolver().insert(Uri.parse(
</span><span style="color: #008080;">18</span>                 "content://media/none/mtp_connected"), <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">19</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">20</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 结束MtpService服务</span>
<span style="color: #008080;">21</span>         context.stopService(<span style="color: #0000ff;">new</span> Intent(context, MtpService.<span style="color: #0000ff;">class</span><span style="color: #000000;">));
</span><span style="color: #008080;">22</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 通知MediaProvider，MTP已经断开。</span>
<span style="color: #008080;">23</span> <span style="color: #000000;">        context.getContentResolver().delete(Uri.parse(
</span><span style="color: #008080;">24</span>                 "content://media/none/mtp_connected"), <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">25</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">26</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">handleUsbState()会先获取"USB连接状态"，"MTP和PTP的Enable"状态。</span></p>
<p><span style="font-size: 14px;">如果USB是连上的，并且MTP或PTP是Enable，则启动MtpService，并通知MediaProvider。</span></p>
<p><span style="font-size: 14px;">否则的话，则终止MtpService，并通知MediaProvider。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-family: 楷体; font-size: 14px;">小结：MtpReceiver会监
听"Android设备开机完成广播" 和 
"USB连接/断开广播"的处理。到收到广播时，会根据"USB的连接状态，MTP/PTP的Enable状态"决定对MTP的处理。如果是连上状态，而
且MTP服务是Enable的，则启动MtpService服务；并且通知MediaProvider。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">2 startService()</span></h1>
<p><span style="font-size: 14px;">在"Android设备与PC连上，并且MTP是Enable"的情况下，MtpService会被启动。在"Android设备与PC断开"时，MtpService会被终止。</span></p>
<p><span style="font-size: 14px;">MtpService的作用是提供管理MTP的服务。例如，MtpService
启动时，它会遍历Android设备上所有的存储设备，如果该存储设备是挂载的，则创建该存储设备对应的MtpStorage对象，并将该
MtpStorage对象添加到MtpDatabase和MtpServer中。在Android设备中存储结构发生变化时，会收到
MediaProvider发来的消息，进而将消息转发给MtpServer，进行MTP同步。</span></p>
<p><span style="font-size: 14px;">下面，通过代码对MtpService进行介绍。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.1 创建MtpService</span></h2>
<p><span style="font-size: 14px;">MtpService继承于Service，这意味着它是一个服务。根据服务的执行流程，MtpService在创建后会执行onCreate()函数。</span></p>
<p><span style="font-size: 14px;">MtpService中onCreate()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MtpService <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Service {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #000000;">    @Override
</span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate() {
</span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 监听“屏幕解锁”广播</span>
<span style="color: #008080;"> 6</span>         registerReceiver(mReceiver, <span style="color: #0000ff;">new</span><span style="color: #000000;"> IntentFilter(Intent.ACTION_USER_PRESENT));
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取StorageManager对象。根据静态工厂方法获取的。</span>
<span style="color: #008080;"> 9</span>         mStorageManager = StorageManager.from(<span style="color: #0000ff;">this</span><span style="color: #000000;">);
</span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mBinder) {
</span><span style="color: #008080;">11</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 根据“屏幕锁定与否”来启动/禁用Mtp功能。
</span><span style="color: #008080;">12</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是当前用户在设定了屏幕解锁密码的情况下锁屏，则禁用Mtp功能。</span>
<span style="color: #008080;">13</span> <span style="color: #000000;">            updateDisabledStateLocked();
</span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 监听“存储设备的挂载/卸载等广播事件”。</span>
<span style="color: #008080;">15</span> <span style="color: #000000;">            mStorageManager.registerListener(mStorageEventListener);
</span><span style="color: #008080;">16</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 遍历“Android设备”上所有存储设备。
</span><span style="color: #008080;">17</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 如果该存储设备是“挂载状态(MEDIA_MOUNTED)”，则通过Mtp锁定该存储设备；
</span><span style="color: #008080;">18</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 这里的Mtp锁定，是指Mtp能识别到该存储设备，并将该存储设备映射到PC上。</span>
<span style="color: #008080;">19</span>             StorageVolume[] volumes =<span style="color: #000000;"> mStorageManager.getVolumeList();
</span><span style="color: #008080;">20</span>             mVolumes =<span style="color: #000000;"> volumes;
</span><span style="color: #008080;">21</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; volumes.length; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">22</span>                 String path =<span style="color: #000000;"> volumes[i].getPath();
</span><span style="color: #008080;">23</span>                 String state =<span style="color: #000000;"> mStorageManager.getVolumeState(path);
</span><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (Environment.MEDIA_MOUNTED.equals(state)) {
</span><span style="color: #008080;">25</span> <span style="color: #000000;">                    volumeMountedLocked(path);
</span><span style="color: #008080;">26</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">27</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">28</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">29</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">32</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) 如果当前用户在设定了"屏幕锁定密码"的情况下将Android设备锁屏，此时MTP功能是被禁用掉的。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; 
&nbsp;updateDisabledStateLocked()的作用，就是处理这种情况的。如果"用户不是当前用户" 或者 
"用户在设定了'屏幕锁定密码'的情况下将Android设备锁屏"；此时MTP功能都是被禁用了的。</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp; &nbsp; &nbsp;mReceiver是处理解锁的广播。当屏幕锁解除之后，MTP又能恢复正常工作！</span></p>
<p><span style="font-size: 14px;">(02) MTP是将Android设备的存储设备映射到PC上。因此，Android设备上的存储设备如果被用户卸载掉的话，要通知PC；而mStorageEventListener就是来监听"Android设备上的存储设备的挂载/卸载状态"的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.2 volumeMountedLocked()</span></h2>
<p><span style="font-size: 14px;">volumeMountedLocked()在MtpService.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> volumeMountedLocked(String path) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 忽略“U盘”</span>
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;">(MediaProvider.UDISK_MOUNT_POINT.equals(path))
</span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在所有的存储设备中遍历，找出该“path对应的存储设备”，并将它添加到mVolumeMap中。</span>
<span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; mVolumes.length; i++<span style="color: #000000;">) {
</span><span style="color: #008080;"> 7</span>         StorageVolume volume =<span style="color: #000000;"> mVolumes[i];
</span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (volume.getPath().equals(path)) {
</span><span style="color: #008080;"> 9</span>             <span style="color: #0000ff;">long</span> reserveSpace = volume.getMtpReserveSpace() * 1024 * 1024<span style="color: #000000;">;
</span><span style="color: #008080;">10</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(path.equals(MediaProvider.LOCAL_MOUNT_POINT))
</span><span style="color: #008080;">11</span>                 volume.setStorageId(0<span style="color: #000000;">);
</span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;">(path.equals(MediaProvider.UDISK_MOUNT_POINT)){
</span><span style="color: #008080;">13</span>                 volume.setStorageId(2<span style="color: #000000;">);
</span><span style="color: #008080;">14</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{
</span><span style="color: #008080;">15</span>                 volume.setStorageId(1<span style="color: #000000;">);
</span><span style="color: #008080;">16</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">17</span> <span style="color: #000000;">            mVolumeMap.put(path, volume);
</span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mMtpDisabled) {
</span><span style="color: #008080;">19</span>                 <span style="color: #0000ff;">if</span> (volume.isPrimary() || !<span style="color: #000000;">mPtpMode) {
</span><span style="color: #008080;">20</span> <span style="color: #000000;">                    addStorageLocked(volume);
</span><span style="color: #008080;">21</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">22</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">24</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">25</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">26</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">虽然 volumeMountedLocked()调用addStorageLocked()。但此时没有进行实质性的动作，真正映射的工作是在onStartCommand()中完成的，即在服务启动之后完成的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.3 onStartCommand()</span></h2>
<p><span style="font-size: 14px;">由于MtpService是"Started Service"类型的服务，而不是"Bound Service"。所以，MtpService启动之后会执行onStartCommand()。</span></p>
<p><span style="font-size: 14px;">MtpService.java中onStartCommand()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span> onStartCommand(Intent intent, <span style="color: #0000ff;">int</span> flags, <span style="color: #0000ff;">int</span><span style="color: #000000;"> startId) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mBinder) {
</span><span style="color: #008080;"> 3</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 根据“屏幕锁定与否”来启动/禁用Mtp功能。
</span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是当前用户在设定了屏幕解锁密码的情况下锁屏，则禁用Mtp功能。</span>
<span style="color: #008080;"> 5</span> <span style="color: #000000;">        updateDisabledStateLocked();
</span><span style="color: #008080;"> 6</span>         mPtpMode = (intent == <span style="color: #0000ff;">null</span> ? <span style="color: #0000ff;">false</span>
<span style="color: #008080;"> 7</span>                 : intent.getBooleanExtra(UsbManager.USB_FUNCTION_PTP, <span style="color: #0000ff;">false</span><span style="color: #000000;">));
</span><span style="color: #008080;"> 8</span>         String[] subdirs = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (mPtpMode) {
</span><span style="color: #008080;">10</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> PTP模型才执行到这里。</span>
<span style="color: #008080;">11</span>             <span style="color: #0000ff;">int</span> count =<span style="color: #000000;"> PTP_DIRECTORIES.length;
</span><span style="color: #008080;">12</span>             subdirs = <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[count];
</span><span style="color: #008080;">13</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; count; i++<span style="color: #000000;">) {
</span><span style="color: #008080;">14</span>                 File file =
<span style="color: #008080;">15</span> <span style="color: #000000;">                        Environment.getExternalStoragePublicDirectory(PTP_DIRECTORIES[i]);
</span><span style="color: #008080;">16</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> make sure this directory exists</span>
<span style="color: #008080;">17</span> <span style="color: #000000;">                file.mkdirs();
</span><span style="color: #008080;">18</span>                 subdirs[i] =<span style="color: #000000;"> file.getPath();
</span><span style="color: #008080;">19</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">20</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">21</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“主存储分区”。</span>
<span style="color: #008080;">22</span>         <span style="color: #0000ff;">final</span> StorageVolume primary =<span style="color: #000000;"> StorageManager.getPrimaryVolume(mVolumes);
</span><span style="color: #008080;">23</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 新建MtpDatabase对象</span>
<span style="color: #008080;">24</span>         mDatabase = <span style="color: #0000ff;">new</span> MtpDatabase(<span style="color: #0000ff;">this</span><span style="color: #000000;">, MediaProvider.LOCAL_VOLUME,
</span><span style="color: #008080;">25</span> <span style="color: #000000;">            primary.getPath(), subdirs);
</span><span style="color: #008080;">26</span> <span style="color: #000000;">        manageServiceLocked();
</span><span style="color: #008080;">27</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> START_STICKY;
</span><span style="color: #008080;">30</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：onStartCommand()中创建了mDatabase对象，然后调用manageServiceLocked()。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.4 manageServiceLocked()</span></h2>
<p><span style="font-size: 14px;">该函数在MtpService.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> manageServiceLocked() {
</span><span style="color: #008080;"> 2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 是不是当前用户</span>
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">boolean</span> isCurrentUser = UserHandle.myUserId() ==<span style="color: #000000;"> ActivityManager.getCurrentUser();
</span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">if</span> (mServer == <span style="color: #0000ff;">null</span> &amp;&amp;<span style="color: #000000;"> isCurrentUser) {
</span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 新建mServer对象</span>
<span style="color: #008080;"> 6</span>         mServer = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MtpServer(mDatabase, mPtpMode);
</span><span style="color: #008080;"> 7</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果MTP没被禁用调，则调用addStorageDevicesLocked()</span>
<span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mMtpDisabled) {
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            addStorageDevicesLocked();
</span><span style="color: #008080;">10</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 启动MtpServer</span>
<span style="color: #008080;">12</span> <span style="color: #000000;">        mServer.start();
</span><span style="color: #008080;">13</span>     } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (mServer != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #000000;">isCurrentUser) {
</span><span style="color: #008080;">14</span>         mServer = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;">15</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">16</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：manageServiceLocked()
会新建MtpServer对象，在通过addStorageDevicesLocked()将存储设备添加到Mtp上之后，再启动MtpServer。
MtpService会启动一个线程用于管理Android设备和PC之间的通信，它也会"将通过addStorageDevicesLocked()添
加的存储设备"映射到PC上。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.5 addStorageDevicesLocked()</span></h2>
<p><span style="font-size: 14px;">该函数在MtpService.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addStorageDevicesLocked() {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (mPtpMode) {
</span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">final</span> StorageVolume primary =<span style="color: #000000;"> StorageManager.getPrimaryVolume(mVolumes);
</span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">final</span> String path =<span style="color: #000000;"> primary.getPath();
</span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">if</span> (path != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 6</span>             String state =<span style="color: #000000;"> mStorageManager.getVolumeState(path);
</span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (Environment.MEDIA_MOUNTED.equals(state)) {
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">                addStorageLocked(mVolumeMap.get(path));
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">10</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">11</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">12</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 如果是MTP模式，则调用addStorageLocked()，mVolumeMap中的存储设备添加到Mtp中。</span>
<span style="color: #008080;">13</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (StorageVolume volume : mVolumeMap.values()) {
</span><span style="color: #008080;">14</span> <span style="color: #000000;">            addStorageLocked(volume);
</span><span style="color: #008080;">15</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">17</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>： 如果是MTP模式，则调用addStorageLocked()，mVolumeMap中的存储设备添加到Mtp中。mVolumeMap在volumeMountedLocked()中已经被初始化，它保存的是挂载状态的存储设备。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">2.6 addStorageLocked()</span></h2>
<p><span style="font-size: 14px;">该函数在MtpService.java中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">该函数在MtpService.java中实现，源码如下：
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addStorageLocked(StorageVolume volume) {
</span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 忽略 “volume为空” 或者 “volume是u盘”的情况</span>
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">if</span>(volume != <span style="color: #0000ff;">null</span> &amp;&amp;<span style="color: #000000;"> MediaProvider.UDISK_MOUNT_POINT.equals(volume.getPath()))
</span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 6</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 新建该“存储设备”对应的MtpStorage，并将该“存储设备”添加到哈希表mStorageMap中。</span>
<span style="color: #008080;"> 7</span>     MtpStorage storage = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MtpStorage(volume, getApplicationContext());
</span><span style="color: #008080;"> 8</span>     String path =<span style="color: #000000;"> storage.getPath();
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    mStorageMap.put(path, storage);
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将storage添加到mDatabase中</span>
<span style="color: #008080;">12</span>     <span style="color: #0000ff;">if</span> (mDatabase != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">13</span> <span style="color: #000000;">        mDatabase.addStorage(storage);
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">15</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将storage添加到mServer中</span>
<span style="color: #008080;">16</span>     <span style="color: #0000ff;">if</span> (mServer != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">17</span> <span style="color: #000000;">        mServer.addStorage(storage);
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">19</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p><span style="font-family: 楷体; font-size: 14px;"><strong>小结</strong>： </span></p>
<p><span style="font-family: 楷体; font-size: 14px;">MtpService服务的主要工作是搜索出
Android设备上所有"挂载"的存储设备，然后根据这些挂载的存储设备分别创建MtpStorage对象；随后，将MtpStorage对象添加到
MtpDatabase中进行数据转换和同步，同时也将MtpStorage添加MtpServer，随后的"Android设备和PC之间的通信和数据
同步等工作"就交由MtpServer主导进行。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">3 insert("mtp_connected")</span></h1>
<p><span style="font-size: 14px;">MtpReceiver在handleUsbState()通过insert()将消息上报给MediaProvider。</span></p>
<h2><span style="font-size: 14px;">3.1 MediaProvider静态注册块</span></h2>
<p><span style="font-size: 14px;">MediaProvider在静态块中添加了对"mtp_connected"事件的监听。源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span>
<span style="color: #008080;">2</span> <span style="color: #000000;">{
</span><span style="color: #008080;">3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">4</span> 
<span style="color: #008080;">5</span>     URI_MATCHER.addURI("media", "*/mtp_connected"<span style="color: #000000;">, MTP_CONNECTED);
</span><span style="color: #008080;">6</span> 
<span style="color: #008080;">7</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">8</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<h2><span style="font-size: 14px;">3.2 MediaProvider中的insert()</span></h2>
<p><span style="font-size: 14px;">当MtpReceiver给MediaProvider发出"插入的mtp_connected"消息时，MediaProvider会执行insert()函数。源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">@Override
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">public</span><span style="color: #000000;"> Uri insert(Uri uri, ContentValues initialValues) {
</span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">int</span> match =<span style="color: #000000;"> URI_MATCHER.match(uri);
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     ArrayList&lt;Long&gt; notifyRowIds = <span style="color: #0000ff;">new</span> ArrayList&lt;Long&gt;<span style="color: #000000;">();
</span><span style="color: #008080;"> 6</span>     Uri newUri =<span style="color: #000000;"> insertInternal(uri, match, initialValues, notifyRowIds);
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    notifyMtp(notifyRowIds);
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> we will signal instead after file transfer is successful.</span>
<span style="color: #008080;">10</span>     <span style="color: #0000ff;">if</span> (newUri != <span style="color: #0000ff;">null</span> &amp;&amp; match !=<span style="color: #000000;"> MTP_OBJECTS) {
</span><span style="color: #008080;">11</span>         getContext().getContentResolver().notifyChange(uri, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">return</span><span style="color: #000000;"> newUri;
</span><span style="color: #008080;">14</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：insert()会调用insertInternal()对消息进行处理。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">3.3 MediaProvider中的insertInternal()</span></h2>
<p><span style="font-size: 14px;">MediaProvider对插入消息的处理在insertInternal()中执行，它的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> Uri insertInternal(Uri uri, <span style="color: #0000ff;">int</span><span style="color: #000000;"> match, ContentValues initialValues,
</span><span style="color: #008080;"> 2</span>                            ArrayList&lt;Long&gt;<span style="color: #000000;"> notifyRowIds) {
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (match) {
</span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_CONNECTED:
</span><span style="color: #008080;"> 7</span>             <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mMtpServiceConnection) {
</span><span style="color: #008080;"> 8</span>                 <span style="color: #0000ff;">if</span> (mMtpService == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 9</span>                     Context context =<span style="color: #000000;"> getContext();
</span><span style="color: #008080;">10</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> 将MediaProvider和MtpService绑定。</span>
<span style="color: #008080;">11</span>                     context.bindService(<span style="color: #0000ff;">new</span> Intent(context, MtpService.<span style="color: #0000ff;">class</span><span style="color: #000000;">),
</span><span style="color: #008080;">12</span> <span style="color: #000000;">                            mMtpServiceConnection, Context.BIND_AUTO_CREATE);
</span><span style="color: #008080;">13</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">14</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">16</span> <span style="color: #000000;">       ...
</span><span style="color: #008080;">17</span> <span style="color: #000000;">   }
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span> <span style="color: #000000;">   ...
</span><span style="color: #008080;">20</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：insertInternal()会调用bindService()将MediaProvider和MtpService绑定。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">4 bindService()</span></h1>
<p><span style="font-size: 14px;">在MediaProvider的insertInternal()中会调用bindService()，而bindService()则会将MediaProvider和MtpService绑定。</span></p>
<p><span style="font-size: 14px;">而之所以要绑定，是为了将实现MTP同步。例如，当Android设备上新建一个文件时，最终后同步到MediaProvider数据库中；而MediaProvider数据库看同步完成之后，会发送消息给MtpService通知它进行MTP的同步。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-family: 楷体; font-size: 14px;">小结：MediaProvider在MtpService启动时和MtpService绑定，在MtpService终止时解除绑定。而绑定的目的是为了实现MTP同步功能。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">5 mDatabase=new MtpDatabase()</span></h1>
<p><span style="font-size: 14px; font-family: 楷体;">在MtpService的onStartCommand()中，会通过new MtpDatabase()创建MtpDatabase对象。</span></p>
<p><span style="font-size: 14px; font-family: 楷体;">MtpDatabase在MTP中，充当着数
据库的功能。但它本身并没有数据库对数据进行保存，本质上是通过MediaProvider数据库获取所需要的数据。例如，当在PC上，需要读取某个文件
时，MtpDatabase会在MediaProvider数据库中查询出文件的相关信息(包括文件名、大小、扩展名等)；然后将这些信息交给
MtpServer，MtpServer将消息传递给JNI，在JNI中会通过文件名打开，然后再文件句柄等信息传递给Kernel；Kernel根据文
件句柄读取文件信息，并传给PC。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">下面，通过代码查看以下MtpDatabase的流程。先看MtpDatabase构造函数，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MtpDatabase {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MtpDatabase(Context context, String volumeName, String storagePath,
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">            String[] subDirectories) {
</span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 调用JNI函数</span>
<span style="color: #008080;"> 6</span> <span style="color: #000000;">        native_setup();
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化</span>
<span style="color: #008080;"> 9</span>         mContext =<span style="color: #000000;"> context;
</span><span style="color: #008080;">10</span>         mPackageName =<span style="color: #000000;"> context.getPackageName();
</span><span style="color: #008080;">11</span>         mMediaProvider = context.getContentResolver().acquireProvider("media"<span style="color: #000000;">);
</span><span style="color: #008080;">12</span>         mVolumeName =<span style="color: #000000;"> volumeName;
</span><span style="color: #008080;">13</span>         mMediaStoragePath =<span style="color: #000000;"> storagePath;
</span><span style="color: #008080;">14</span>         mObjectsUri =<span style="color: #000000;"> Files.getMtpObjectsUri(volumeName);
</span><span style="color: #008080;">15</span>         mMediaScanner = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MediaScanner(context);
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>         mSubDirectories =<span style="color: #000000;"> subDirectories;
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 初始化设备属性，将其保存到SharedPreferences中</span>
<span style="color: #008080;">22</span> <span style="color: #000000;">        initDeviceProperties(context);
</span><span style="color: #008080;">23</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">26</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：MtpDatabase的构造函数主要进行的是初始化工作，它首先会调用native_setup()。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">5.1 native_setup()</span></h2>
<p><span style="font-size: 14px;">native_setup()在MtpDatabase.java中是一个本地方法。它的相关定义如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> {
</span><span style="color: #008080;">2</span>     System.loadLibrary("media_jni"<span style="color: #000000;">);
</span><span style="color: #008080;">3</span> <span style="color: #000000;">}
</span><span style="color: #008080;">4</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">native</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span> native_setup();</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">从中可以看出native_setup()的实现在libmedia_jni.so中，准确的说是在android_mtp_MtpDatabase.cpp中的注册。相关的代码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span> JNINativeMethod gMtpDatabaseMethods[] =<span style="color: #000000;"> {
</span><span style="color: #008080;">2</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_setup</span><span style="color: #800000;">"</span>,            <span style="color: #800000;">"</span><span style="color: #800000;">()V</span><span style="color: #800000;">"</span>,  (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpDatabase_setup},
</span><span style="color: #008080;">3</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_finalize</span><span style="color: #800000;">"</span>,         <span style="color: #800000;">"</span><span style="color: #800000;">()V</span><span style="color: #800000;">"</span>,  (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpDatabase_finalize},
</span><span style="color: #008080;">4</span> };</pre>
</div>
<p><span style="font-size: 14px;">从中，我们看出，native_setup()实际上是和JNI中的android_mtp_MtpDatabase_setup()对应。android_mtp_MtpDatabase_setup()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> android_mtp_MtpDatabase_setup(JNIEnv *<span style="color: #000000;">env, jobject thiz)
</span><span style="color: #008080;">2</span> <span style="color: #000000;">{
</span><span style="color: #008080;">3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 新建MyMtpDatabase对象database</span>
<span style="color: #008080;">4</span>     MyMtpDatabase* database = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MyMtpDatabase(env, thiz);
</span><span style="color: #008080;">5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将database对象保存“field_context”域中。</span>
<span style="color: #008080;">6</span>     env-&gt;SetIntField(thiz, field_context, (<span style="color: #0000ff;">int</span><span style="color: #000000;">)database);
</span><span style="color: #008080;">7</span> <span style="color: #000000;">    checkAndClearExceptionFromCallback(env, __FUNCTION__);
</span><span style="color: #008080;">8</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">android_mtp_MtpDatabase_setup()会创建一个MyMtpDatabase对象，并将该对象保存"field_context"域中。这个被保存的MyMtpDatabase对象在后面会被用到。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">5.2 database=new MyMtpDatabase()</span></h2>
<p><span style="font-size: 14px;">MyMtpDatabase位于"JNI层"，它与"Java层的MtpDatabase"对应。MTP通过调用MyMtpDatabase的接口，给Java层的MtpDatabase发送消息；从而进行相关MTP数据的收集。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-family: 楷体; font-size: 14px;">小结：MtpDatabase的相当于MTP
的数据库。在MtpDatabase的创建过程中，它最终会调用JNI本地方法，创建一个MyMtpDatabase对象，并将该对象保存在域
field_context中。MTP通过调用保存在field_context域中的MyMtpDatabase对象，从而调用
MtpDatabase，进而获取相关的数据。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">6 mServer=new MtpServer()</span></h1>
<p><span style="font-size: 14px; font-family: 楷体;">MtpServer是一个实现Runnable接口，它相当于一个线程；并且在MtpService中被启动。</span></p>
<p><span style="font-size: 14px; font-family: 楷体;">MtpServer在MTP的Framework层中，充当着服务器的角色。例如，当MTP服务启动时，它会通知底层；当Android设备中新增文件时，它会收到MtpService的消息，并将该消息转发给底层。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">MtpServer的构造函数源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MtpServer implements Runnable {
</span><span style="color: #008080;">2</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MtpServer(MtpDatabase database, boolean usePtp) {
</span><span style="color: #008080;">3</span> <span style="color: #000000;">        native_setup(database, usePtp);
</span><span style="color: #008080;">4</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">5</span> 
<span style="color: #008080;">6</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">7</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：MtpServer实现了Runnable接口，在它的构造函数中，它会调用native_setup()本地方法。在MtpServer中，声明了许多native方法，它们的相关代码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 2</span>     System.loadLibrary(<span style="color: #800000;">"</span><span style="color: #800000;">media_jni</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">}
</span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span><span style="color: #000000;"> native_setup(MtpDatabase database, boolean usePtp);
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span><span style="color: #000000;"> native_run();
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span><span style="color: #000000;"> native_cleanup();
</span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span> native_send_object_added(<span style="color: #0000ff;">int</span><span style="color: #000000;"> handle);
</span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span> native_send_object_removed(<span style="color: #0000ff;">int</span><span style="color: #000000;"> handle);
</span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span><span style="color: #000000;"> native_add_storage(MtpStorage storage);
</span><span style="color: #008080;">10</span> <span style="color: #0000ff;">private</span> native final <span style="color: #0000ff;">void</span> native_remove_storage(<span style="color: #0000ff;">int</span> storageId);</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="line-height: 1.5;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">6.1 native_setup()</span></h2>
<p><span style="font-size: 14px;">MtpServer中的native方法在android_mtp_MtpServer.cpp中注册，注册表格如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> JNINativeMethod gMethods[] =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 2</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_setup</span><span style="color: #800000;">"</span>,                <span style="color: #800000;">"</span><span style="color: #800000;">(Landroid/mtp/MtpDatabase;Z)V</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 3</span>                                             (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_setup},
</span><span style="color: #008080;"> 4</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_run</span><span style="color: #800000;">"</span>,                  <span style="color: #800000;">"</span><span style="color: #800000;">()V</span><span style="color: #800000;">"</span>,  (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_run},
</span><span style="color: #008080;"> 5</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_cleanup</span><span style="color: #800000;">"</span>,              <span style="color: #800000;">"</span><span style="color: #800000;">()V</span><span style="color: #800000;">"</span>,  (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_cleanup},
</span><span style="color: #008080;"> 6</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_send_object_added</span><span style="color: #800000;">"</span>,    <span style="color: #800000;">"</span><span style="color: #800000;">(I)V</span><span style="color: #800000;">"</span>, (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_send_object_added},
</span><span style="color: #008080;"> 7</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_send_object_removed</span><span style="color: #800000;">"</span>,  <span style="color: #800000;">"</span><span style="color: #800000;">(I)V</span><span style="color: #800000;">"</span>, (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_send_object_removed},
</span><span style="color: #008080;"> 8</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_add_storage</span><span style="color: #800000;">"</span>,          <span style="color: #800000;">"</span><span style="color: #800000;">(Landroid/mtp/MtpStorage;)V</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;"> 9</span>                                             (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_add_storage},
</span><span style="color: #008080;">10</span>     {<span style="color: #800000;">"</span><span style="color: #800000;">native_remove_storage</span><span style="color: #800000;">"</span>,       <span style="color: #800000;">"</span><span style="color: #800000;">(I)V</span><span style="color: #800000;">"</span>, (<span style="color: #0000ff;">void</span> *<span style="color: #000000;">)android_mtp_MtpServer_remove_storage},
</span><span style="color: #008080;">11</span> };</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;">从中，我们直到native_setup()实际上是与android_mtp_MtpServer_setup()对应。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">android_mtp_MtpServer_setup()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> android_mtp_MtpServer_setup(JNIEnv *<span style="color: #000000;">env, jobject thiz, jobject javaDatabase, jboolean usePtp)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 打开文件“/dev/mtp_usb”</span>
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">int</span> fd = open(<span style="color: #800000;">"</span><span style="color: #800000;">/dev/mtp_usb</span><span style="color: #800000;">"</span><span style="color: #000000;">, O_RDWR);
</span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">if</span> (fd &gt;= <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 根据“fd”和“MtpDatabase”创建MtpServer对象server</span>
<span style="color: #008080;"> 7</span>         MtpServer* server = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MtpServer(fd, getMtpDatabase(env, javaDatabase),
</span><span style="color: #008080;"> 8</span>                 usePtp, AID_MEDIA_RW, <span style="color: #800080;">0664</span>, <span style="color: #800080;">0775</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将server对象保存到“field_MtpServer_nativeContext”域中。</span>
<span style="color: #008080;">10</span>         env-&gt;SetIntField(thiz, field_MtpServer_nativeContext, (<span style="color: #0000ff;">int</span><span style="color: #000000;">)server);
</span><span style="color: #008080;">11</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">12</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">could not open MTP driver, errno: %d</span><span style="color: #800000;">"</span><span style="color: #000000;">, errno);
</span><span style="color: #008080;">13</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">14</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) fd是文件"/dev/mtp_usb"的句柄。实际上，MTP是通过"/dev/mtp_usb"去监听PC的请求和向PC发送数据的。</span></p>
<p><span style="font-size: 14px;">(02) getMtpDatabase(env, javaDatabase)返回的是MtpDatabase对象。</span></p>
<p><span style="font-size: 14px;">(03) 根据fd和getMtpDatabase()返回的MtpDatabase对象，创建server对象；然后通过SetIntFiel()将server对象保存到field_MtpServer_nativeContext这个域中。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">6.2 fd = open("/dev/mtp_usb")</span></h2>
<p><span style="font-size: 14px;">android_mtp_MtpServer_setup()会打开"/dev
/mtp_usb"文件。在MTP中，MtpServer会不断的从"/dev/mtp_usb"去读取数据来监听PC的请求；同时，数据反馈和其他事件
也是通过"/dev/mtp_usb"去反馈给Kernel的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">6.3 getMtpDatabase()</span></h2>
<p><span style="font-size: 14px;">该函数在android_mtp_MtpDatabase.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> MtpDatabase* getMtpDatabase(JNIEnv *<span style="color: #000000;">env, jobject database) {
</span><span style="color: #008080;">2</span>     <span style="color: #0000ff;">return</span> (MtpDatabase *)env-&gt;<span style="color: #000000;">GetIntField(database, field_context);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：field_context在前面介绍的"android_mtp_MtpDatabase_setup()"中被初始化。所以，这里实际上返回的是MyMtpDatabase对象。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">6.4 new MtpServer(fd, ...)</span></h2>
<p><span style="font-size: 14px;">MtpServer的构造函数在MtpServer.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre>MtpServer::MtpServer(<span style="color: #0000ff;">int</span> fd, MtpDatabase* database, <span style="color: #0000ff;">bool</span><span style="color: #000000;"> ptp,
                    </span><span style="color: #0000ff;">int</span> fileGroup, <span style="color: #0000ff;">int</span> filePerm, <span style="color: #0000ff;">int</span><span style="color: #000000;"> directoryPerm)
    :   mFD(fd),
        mDatabase(database),
        mPtp(ptp),
        mFileGroup(fileGroup),
        mFilePermission(filePerm),
        mDirectoryPermission(directoryPerm),
        mSessionID(</span><span style="color: #800080;">0</span><span style="color: #000000;">),
        mSessionOpen(</span><span style="color: #0000ff;">false</span><span style="color: #000000;">),
        mSendObjectHandle(kInvalidObjectHandle),
        mSendObjectFormat(</span><span style="color: #800080;">0</span><span style="color: #000000;">),
        mSendObjectFileSize(</span><span style="color: #800080;">0</span>) {}</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">其中比较重要的两则信息：(01) mFD是"/dev/mtp_usb"的文件句柄。 (02) mDatabase是上一步getMtpDatabase()返回的MtpDatabase对象。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">7 storage = new MtpStorage()</span></h1>
<p><span style="font-size: 14px;">一个MtpStorage对象代表一个MTP存储单元。当Android设备和PC连上时，可能有几个存储单元：例如，内部存储分区，SD卡分区等。</span></p>
<p><span style="font-size: 14px;">MtpStorage的构造函数如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MtpStorage {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mStorageId;
</span><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> String mPath;
</span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span><span style="color: #000000;"> String mDescription;
</span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> mReserveSpace;
</span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> mRemovable;
</span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> mMaxFileSize;
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> MtpStorage(StorageVolume volume, Context context) {
</span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 存储设备ID</span>
<span style="color: #008080;">11</span>         mStorageId =<span style="color: #000000;"> volume.getStorageId();
</span><span style="color: #008080;">12</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 对应“Android设备”上的存储路径</span>
<span style="color: #008080;">13</span>         mPath =<span style="color: #000000;"> volume.getPath();
</span><span style="color: #008080;">14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 描述</span>
<span style="color: #008080;">15</span>         mDescription =<span style="color: #000000;"> context.getResources().getString(volume.getDescriptionId());
</span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> (对MTP而言)可用空间</span>
<span style="color: #008080;">17</span>         mReserveSpace = volume.getMtpReserveSpace() * 1024L * 1024L<span style="color: #000000;">;
</span><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 是否可移除</span>
<span style="color: #008080;">19</span>         mRemovable =<span style="color: #000000;"> volume.isRemovable();
</span><span style="color: #008080;">20</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 最大文件大小。(0表示无限制)</span>
<span style="color: #008080;">21</span>         mMaxFileSize =<span style="color: #000000;"> volume.getMaxFileSize();
</span><span style="color: #008080;">22</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">25</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<h1><span style="font-size: 14px;">8 mDatabase.addStorage(storage)</span></h1>
<p><span style="font-size: 14px;">MtpDatabase.java中addStorage()的源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addStorage(MtpStorage storage) {
    mStorageMap.put(storage.getPath(), storage);
}
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> removeStorage(MtpStorage storage) {
    mStorageMap.remove(storage.getPath());
}</span></pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：mStorageMap是个
HashMap对象。此处，addStorage()的作用就是将"存储设备的信息保存到哈希表中"。当该存储设备被卸载时，会调用
MtpDatabase.java的removeStorage()，进而从mStorageMap中删除相应的存储设备。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">9 mServer.addStorage(storage)</span></h1>
<p><span style="font-size: 14px;">mServer.addStorage(storage) 会对应执行MtpServer.java中的addStorage()函数。源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> addStorage(MtpStorage storage) {
</span><span style="color: #008080;">2</span> <span style="color: #000000;">    native_add_storage(storage);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;">根据前面介绍的gMethods表格，我们知道native_add_storage()实际上是调用的android_mtp_MtpServer_add_storage()。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.1 android_mtp_MtpServer_add_storage()</span></h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> android_mtp_MtpServer_add_storage(JNIEnv *<span style="color: #000000;">env, jobject thiz, jobject jstorage)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    Mutex::Autolock autoLock(sMutex);
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获取MtpServer对象</span>
<span style="color: #008080;"> 6</span>     MtpServer* server =<span style="color: #000000;"> getMtpServer(env, thiz);
</span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (server) {
</span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_storageId 和 “MtpStorage.java中的mStorageId” 对应</span>
<span style="color: #008080;"> 9</span>         jint storageID = env-&gt;<span style="color: #000000;">GetIntField(jstorage, field_MtpStorage_storageId);
</span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_path 和 “MtpStorage.java中的mPath” 对应</span>
<span style="color: #008080;">11</span>         jstring path = (jstring)env-&gt;<span style="color: #000000;">GetObjectField(jstorage, field_MtpStorage_path);
</span><span style="color: #008080;">12</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_description 和 “MtpStorage.java中的mDescription” 对应</span>
<span style="color: #008080;">13</span>         jstring description = (jstring)env-&gt;<span style="color: #000000;">GetObjectField(jstorage, field_MtpStorage_description);
</span><span style="color: #008080;">14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_reserveSpace 和 “MtpStorage.java中的mReserveSpace” 对应</span>
<span style="color: #008080;">15</span>         jlong reserveSpace = env-&gt;<span style="color: #000000;">GetLongField(jstorage, field_MtpStorage_reserveSpace);
</span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_removable 和 “MtpStorage.java中的mRemovable” 对应</span>
<span style="color: #008080;">17</span>         jboolean removable = env-&gt;<span style="color: #000000;">GetBooleanField(jstorage, field_MtpStorage_removable);
</span><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> field_MtpStorage_maxFileSize 和 “MtpStorage.java中的mMaxFileSize” 对应</span>
<span style="color: #008080;">19</span>         jlong maxFileSize = env-&gt;<span style="color: #000000;">GetLongField(jstorage, field_MtpStorage_maxFileSize);
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将“jstring类型的path”转换为“C语言中的char *类型”</span>
<span style="color: #008080;">22</span>         <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *pathStr = env-&gt;<span style="color: #000000;">GetStringUTFChars(path, NULL);
</span><span style="color: #008080;">23</span>         <span style="color: #0000ff;">if</span> (pathStr !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">24</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“存储设备”的描述字符串</span>
<span style="color: #008080;">25</span>             <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *descriptionStr = env-&gt;<span style="color: #000000;">GetStringUTFChars(description, NULL);
</span><span style="color: #008080;">26</span>             <span style="color: #0000ff;">if</span> (descriptionStr !=<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">27</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 创建(MtpStorage.cpp)MtpStorage对象</span>
<span style="color: #008080;">28</span>                 MtpStorage* storage = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MtpStorage(storageID, pathStr, descriptionStr,
</span><span style="color: #008080;">29</span> <span style="color: #000000;">                        reserveSpace, removable, maxFileSize);
</span><span style="color: #008080;">30</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 将该MtpStorage对象，添加到MtpServer中</span>
<span style="color: #008080;">31</span>                 server-&gt;<span style="color: #000000;">addStorage(storage);
</span><span style="color: #008080;">32</span>                 env-&gt;<span style="color: #000000;">ReleaseStringUTFChars(path, pathStr);
</span><span style="color: #008080;">33</span>                 env-&gt;<span style="color: #000000;">ReleaseStringUTFChars(description, descriptionStr);
</span><span style="color: #008080;">34</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">35</span>                 env-&gt;<span style="color: #000000;">ReleaseStringUTFChars(path, pathStr);
</span><span style="color: #008080;">36</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">37</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">38</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">39</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">server is null in add_storage</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">40</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">41</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) getMtpServer()返回的是MtpServer对象。</span></p>
<p><span style="font-size: 14px;">(02) 通过GetIntField(), GetObjectField()等一系列操作，将相关的域分别和MtpStorage.java中的域对应起来。</span></p>
<p><span style="font-size: 14px;">(03) 创建MtpStorage对象。</span></p>
<p><span style="font-size: 14px;">(04) 通过addStorage()将MtpStorage对象，添加到MtpServer中。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.2 server=getMtpServer()</span></h2>
<p><span style="font-size: 14px;">getMtpServer()在android_mtp_MtpServer.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span> inline MtpServer* getMtpServer(JNIEnv *<span style="color: #000000;">env, jobject thiz) {
</span><span style="color: #008080;">2</span>     <span style="color: #0000ff;">return</span> (MtpServer*)env-&gt;<span style="color: #000000;">GetIntField(thiz, field_MtpServer_nativeContext);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：getMtpServer()返回的是MtpServer对象。该对象，我们在前面介绍的"android_mtp_MtpServer_setup()"的初始化的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.3 storage=new MtpStorage()</span></h2>
<p><span style="font-size: 14px;">在android_mtp_MtpServer_add_storage()中，
我们通过GetIntField(),GetObjectField(), 
GetLongField()等方法获取"JNI中的域"对应的"MtpStoarge.java中的类成员"。下面以
field_MtpStorage_storageId为例，简单说说"JNI中的域"是如何与"MtpStorage.java中的
mStorageId"关联的。</span></p>
<p><span style="font-size: 14px;">首先，field_MtpStorage_storageId的值是在register_android_mtp_MtpServer()中初始化的。源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">int</span> register_android_mtp_MtpServer(JNIEnv *<span style="color: #000000;">env)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    jclass clazz;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 找到java中“android.mtp.MtpStorage.java”包</span>
<span style="color: #008080;"> 6</span>     clazz = env-&gt;FindClass(<span style="color: #800000;">"</span><span style="color: #800000;">android/mtp/MtpStorage</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“MtpStorage.java中mStorageId”的fieldId，并保存到field_MtpStorage_storageId中</span>
<span style="color: #008080;">10</span>     field_MtpStorage_storageId = env-&gt;GetFieldID(clazz, <span style="color: #800000;">"</span><span style="color: #800000;">mStorageId</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">I</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">if</span> (field_MtpStorage_storageId ==<span style="color: #000000;"> NULL) {
</span><span style="color: #008080;">12</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">Can't find MtpStorage.mStorageId</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">return</span> -<span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> <span style="color: #000000;">    ..
</span><span style="color: #008080;">17</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p><span style="font-size: 14px;">register_android_mtp_MtpServer()又是何时被调用的呢？</span></p>
<p><span style="font-size: 14px;">它是在android_media_MediaPlayer.cpp的JNI_OnLoad()中被调用的，而JNI_OnLoad是我们调用JNI对应的库时被JNI自动调用执行的。</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> jint JNI_OnLoad(JavaVM* vm, <span style="color: #0000ff;">void</span>*<span style="color: #000000;"> reserved)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">if</span> (register_android_mtp_MtpServer(env) &lt; <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 6</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">ERROR: MtpServer native registration failed</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">goto</span><span style="color: #000000;"> bail;
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">11</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p><span style="font-size: 14px;">由于在register_android_mtp_MtpServer()中，"MtpStorage.java中mStorageId"的已经保存field_MtpStorage_storageId中；</span></p>
<p><span style="font-size: 14px;">在android_mtp_MtpServer_add_storage()中，
我们就可以通过env-&gt;GetIntField(jstorage, 
field_MtpStorage_storageId)来获取"MtpStorage.java中mStorageId"。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">下面，我们看看MtpStorage.h(JNI层)中的成员如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> MtpStorage {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">private</span><span style="color: #000000;">:
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    MtpStorageID            mStorageID;
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    MtpString               mFilePath;
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    MtpString               mDescription;
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    uint64_t                mMaxCapacity;
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    uint64_t                mMaxFileSize;
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    uint64_t                mReserveSpace;
</span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">bool</span><span style="color: #000000;">                    mRemovable;
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">13</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;">将MtpStroage.h(JNI层)中的成员和"前面介绍的MtpStroage.java的成员"进行对比，它们非常相似。实际上，MTP就是通过MtpStorage.cpp来获取MtpStorage.java的相关信息的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.4 server-&gt;addStorage(storage)</span></h2>
<p><span style="font-size: 14px;">MtpServer.cpp中addStorage()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">void</span> MtpServer::addStorage(MtpStorage*<span style="color: #000000;"> storage) {
</span><span style="color: #008080;">2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“信号量”</span>
<span style="color: #008080;">3</span> <span style="color: #000000;">    Mutex::Autolock autoLock(mMutex);
</span><span style="color: #008080;">4</span> 
<span style="color: #008080;">5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> mStorages是“MtpStorage的Vector容量对象”，相当于“MtpStorage的动态数组”。</span>
<span style="color: #008080;">6</span> <span style="color: #000000;">    mStorages.push(storage);
</span><span style="color: #008080;">7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 调用sendStoreAdded()通知PC，让PC通过MTP挂载该存储设备</span>
<span style="color: #008080;">8</span>     sendStoreAdded(storage-&gt;<span style="color: #000000;">getStorageID());
</span><span style="color: #008080;">9</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：addStorage()的作用，就是将"输入参数storage"添加到"mStorages动态数组"中进行管理；然后，调用sendStoreAdded()告诉PC挂载该设备。下面看看sendStoreAdded()是如何处理的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.5 sendStoreAdded()</span></h2>
<p><span style="font-size: 14px;">MtpServer.cpp中sendStoreAdded()的源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpServer::sendStoreAdded(MtpStorageID id) {
</span><span style="color: #008080;">2</span> <span style="color: #000000;">    sendEvent(MTP_EVENT_STORE_ADDED, id);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">MTP_EVENT_STORE_ADDED是"MtpEventCode类型"的数组中的成员，而MtpEventCode是uint16_t类型。所以，MTP_EVENT_STORE_ADDED是一个"16位的无符号整型数"，它代表的是一个MTP事件指令ID。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.6 sendEvent()</span></h2>
<p><span style="font-size: 14px;">MtpServer.cpp中sendEvent()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpServer::sendEvent(MtpEventCode code, uint32_t param1) {
</span><span style="color: #008080;">2</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (mSessionOpen) {
</span><span style="color: #008080;">3</span> <span style="color: #000000;">        mEvent.setEventCode(code);
</span><span style="color: #008080;">4</span> <span style="color: #000000;">        mEvent.setTransactionID(mRequest.getTransactionID());
</span><span style="color: #008080;">5</span>         mEvent.setParameter(<span style="color: #800080;">1</span><span style="color: #000000;">, param1);
</span><span style="color: #008080;">6</span>         <span style="color: #0000ff;">int</span> ret =<span style="color: #000000;"> mEvent.write(mFD);
</span><span style="color: #008080;">7</span>         ALOGV(<span style="color: #800000;">"</span><span style="color: #800000;">mEvent.write returned %d\n</span><span style="color: #800000;">"</span><span style="color: #000000;">, ret);
</span><span style="color: #008080;">8</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">9</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) 
mSessionOpen是"MTP会话是否打开的标记"。当PC和Android设备连上之后，PC会发送"打开会话指令"给Android设备从而开
打会话；到PC和Android设备断开时，会话才结束。在打开会话时，会设置mSessionOpen为true。这也意味着，此时的
mSessionOpen已经为true。</span></p>
<p><span style="font-size: 14px;">(02) mEvent是MtpEventPacket对象。而MtpEventPacket继承于MtpPacket，MtpEventPacket声明如下：</span></p>
<p><span style="font-size: 14px;">class MtpEventPacket : public MtpPacket {}</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">9.7 mEvent.write()</span></h2>
<p><span style="font-size: 14px;">sendEvent()在执行mEvent.write()之前，会初始化mEvent对象。</span></p>
<p><span style="font-size: 14px;">9.7.1 setEventCode()</span></p>
<p><span style="font-size: 14px;">setEventCode()在MtpEventPacket.h中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre>inline <span style="color: #0000ff;">void</span> setEventCode(MtpEventCode code) { <span style="color: #0000ff;">return</span> setContainerCode(code); }</pre>
</div>
<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p><span style="font-size: 14px;">setContainerCode()在MtpPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpPacket::setContainerCode(uint16_t code) {
    putUInt16(MTP_CONTAINER_CODE_OFFSET, code);
}</span></pre>
</div>
<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p><span style="font-size: 14px;">putUInt16()在MtpPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">void</span> MtpPacket::putUInt16(<span style="color: #0000ff;">int</span><span style="color: #000000;"> offset, uint16_t value) {
    mBuffer[offset</span>++] = (uint8_t)(value &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
    mBuffer[offset</span>++] = (uint8_t)((value &gt;&gt; <span style="color: #800080;">8</span>) &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
}</span></pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">putUInt16()是"将16位的无符号整型数 写入 到缓冲中"。其中，mBuffer是"数据缓冲"。</span></p>
<p><span style="font-size: 14px;">综上所述，setEventCode(code)的作用就是将"消息的编码写入到缓冲"，等其他数据写入缓冲之后，再一起发送给PC。对于"添加存储设备而言"，Android设备发给PC的消息的编码就是MTP_EVENT_STORE_ADDED。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">9.7.2 setTransactionID()</span></p>
<p><span style="font-size: 14px;">setTransactionID()在MtpPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpPacket::setTransactionID(MtpTransactionID id) {
    putUInt32(MTP_CONTAINER_TRANSACTION_ID_OFFSET, id);
}</span></pre>
</div>
<p><span style="line-height: 1.5;">&nbsp;</span></p>
<p><span style="font-size: 14px;">putUInt32()在MtpPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">void</span> MtpPacket::putUInt32(<span style="color: #0000ff;">int</span><span style="color: #000000;"> offset, uint32_t value) {
    mBuffer[offset</span>++] = (uint8_t)(value &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
    mBuffer[offset</span>++] = (uint8_t)((value &gt;&gt; <span style="color: #800080;">8</span>) &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
    mBuffer[offset</span>++] = (uint8_t)((value &gt;&gt; <span style="color: #800080;">16</span>) &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
    mBuffer[offset</span>++] = (uint8_t)((value &gt;&gt; <span style="color: #800080;">24</span>) &amp; <span style="color: #800080;">0xFF</span><span style="color: #000000;">);
}</span></pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">putUInt32()和putUInt16()作用类似，putUInt32()的作用是"将32位的无符号整型数 写入 到缓冲中"。其中，mBuffer是"数据缓冲"。</span></p>
<p><span style="font-size: 14px;">综上所述，setTransactionID()就是将"TransactionID写入到缓冲"。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">9.7.3 setParameter()</span></p>
<p><span style="font-size: 14px;">setParameter()在MtpPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">void</span> MtpPacket::setParameter(<span style="color: #0000ff;">int</span><span style="color: #000000;"> index, uint32_t value) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">if</span> (index &lt; <span style="color: #800080;">1</span> || index &gt; <span style="color: #800080;">5</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 3</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">index %d out of range in MtpPacket::setParameter</span><span style="color: #800000;">"</span><span style="color: #000000;">, index);
</span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    }
</span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">int</span> offset = MTP_CONTAINER_PARAMETER_OFFSET + (index - <span style="color: #800080;">1</span>) * <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(uint32_t);
</span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span> (mPacketSize &lt; offset + <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(uint32_t))
</span><span style="color: #008080;"> 8</span>         mPacketSize = offset + <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(uint32_t);
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    putUInt32(offset, value);
</span><span style="color: #008080;">10</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>： setParameter()的作用是"将StorageID写入缓冲"，从而告诉PC操作哪个"存储设备"。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">9.7.4 write()</span></p>
<p><span style="font-size: 14px;">write()在MtpEventPacket.cpp中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">int</span> MtpEventPacket::write(<span style="color: #0000ff;">int</span><span style="color: #000000;"> fd) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">struct</span> mtp_event    <span style="color: #0000ff;">event</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span> <span style="color: #000000;">    putUInt32(MTP_CONTAINER_LENGTH_OFFSET, mPacketSize);
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    putUInt16(MTP_CONTAINER_TYPE_OFFSET, MTP_CONTAINER_TYPE_EVENT);
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将“缓冲”赋值给event.data</span>
<span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">event</span>.data =<span style="color: #000000;"> mBuffer;
</span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">event</span>.length =<span style="color: #000000;"> mPacketSize;
</span><span style="color: #008080;">10</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 通过“ioctl事件”将该消息发送给驱动，驱动再负责和PC通信。</span>
<span style="color: #008080;">11</span>     <span style="color: #0000ff;">int</span> ret = ::ioctl(fd, MTP_SEND_EVENT, (unsigned <span style="color: #0000ff;">long</span>)&amp;<span style="color: #0000ff;">event</span><span style="color: #000000;">);
</span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">return</span> (ret &lt; <span style="color: #800080;">0</span> ? ret : <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">13</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">write()的作用，就是将打包好的消息发送给PC。write()的作用是将消息传递给Kernel，真正传递给PC是在Kernel的驱动中进行处理的。感兴趣的可以看看下面Kernel的write()介绍部分。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">下面简单介绍下Kernel中write()是如何实现的。通过前面介绍的MTP架构图，我们知道：</span></p>
<p><span style="font-size: 14px; font-family: 楷体;">(01) PC和Android设备是通过USB协议来进行MTP通信的。</span></p>
<p><span style="font-size: 14px; color: #ff0000; font-family: 楷体;">&nbsp; &nbsp; &nbsp; 注意：MTP协议除了USB之外，还可以通过BT等协议进行通信；这里只对USB进行说明。</span></p>
<p><span style="font-size: 14px; font-family: 楷体;">(02) 
PC给Android设备发送消息时，PC会通过USB传输数据给内核。MTP驱动再从USB中读取出"PC传过来的消息"，然后写入到"/dev
/mtp_usb"文件节点上。"/dev/mtp_usb"是MTP驱动对应的节点，在Linux中，一切都是文件；用户通过操作"/dev
/mtp_usb"节点，就能读取出"PC发过来的消息"。</span></p>
<p><span style="font-size: 14px; font-family: 楷体;">(03) Android设备给PC发送消息时，会向将信息写入到"/dev/mtp_usb"文件中。MTP驱动从"/dev/mtp_usb"中读取数据之后，再通过USB传给送PC。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">一. MTP驱动注册</span></h2>
<p><span style="font-size: 14px;">MTP驱动文件是drivers/usb/gadget/f_mtp.c。它通过下面的代码会映射到文件节点"/dev/mtp_usb"中。</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> mtp_shortname[] = <span style="color: #800000;">"</span><span style="color: #800000;">mtp_usb</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> file_operations mtp_fops =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 4</span>     .owner =<span style="color: #000000;"> THIS_MODULE,
</span><span style="color: #008080;"> 5</span>     .read =<span style="color: #000000;"> mtp_read,
</span><span style="color: #008080;"> 6</span>     .write =<span style="color: #000000;"> mtp_write,
</span><span style="color: #008080;"> 7</span>     .unlocked_ioctl =<span style="color: #000000;"> mtp_ioctl,
</span><span style="color: #008080;"> 8</span>     .open =<span style="color: #000000;"> mtp_open,
</span><span style="color: #008080;"> 9</span>     .release =<span style="color: #000000;"> mtp_release,
</span><span style="color: #008080;">10</span> <span style="color: #000000;">}; 
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">struct</span> miscdevice mtp_device =<span style="color: #000000;"> {
</span><span style="color: #008080;">13</span>     .minor =<span style="color: #000000;"> MISC_DYNAMIC_MINOR,
</span><span style="color: #008080;">14</span>     .name =<span style="color: #000000;"> mtp_shortname,
</span><span style="color: #008080;">15</span>     .fops = &amp;<span style="color: #000000;">mtp_fops,
</span><span style="color: #008080;">16</span> <span style="color: #000000;">};  
</span><span style="color: #008080;">17</span> 
<span style="color: #008080;">18</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> mtp_setup(<span style="color: #0000ff;">void</span><span style="color: #000000;">)
</span><span style="color: #008080;">19</span> <span style="color: #000000;">{
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>     ret = misc_register(&amp;<span style="color: #000000;">mtp_device);
</span><span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">25</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) misc_register(&amp;mtp_device)会将MTP注册到虚拟文件系统"/dev"中，而对应的注册的文件节点的名称是"mtp_usb"，即完成的节点是"/dev/mtp_usb"。</span></p>
<p><span style="font-size: 14px;">(02) 用户空间操作节点"/dev/mtp_usb"就是调用MTP驱动中file_operations中的相关函数。</span></p>
<p><span style="font-size: 14px;">例如，用户空间通过read()去读取"/dev/mtp_usb"，实际上调用内核空间的是mtp_read()；用户空间通过write()去写"/dev/mtp_usb"，实际上调用内核空间的是mtp_write()。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">二. mtp_read()</span></h2>
<p><span style="font-size: 14px;">该函数在f_mtp.c中实现，源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> ssize_t mtp_read(<span style="color: #0000ff;">struct</span> file *fp, <span style="color: #0000ff;">char</span> __user *<span style="color: #000000;">buf,
</span><span style="color: #008080;"> 2</span>     size_t count, loff_t *<span style="color: #000000;">pos)
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 从“USB”消息队列中中读取PC发给Android设备的请求，请求消息保存在req中。</span>
<span style="color: #008080;"> 5</span>     ret = usb_ep_queue(dev-&gt;<span style="color: #000000;">ep_out, req, GFP_KERNEL);
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 等待cpu将工作队列(read_wq)上已有的消息处理完毕</span>
<span style="color: #008080;"> 9</span>     ret = wait_event_interruptible(dev-&gt;read_wq, dev-&gt;<span style="color: #000000;">rx_done);
</span><span style="color: #008080;">10</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将“PC的请求数据(req-&gt;)”从“内核空间”拷贝到“用户空间”</span>
<span style="color: #008080;">13</span>     <span style="color: #0000ff;">if</span> (copy_to_user(buf, req-&gt;<span style="color: #000000;">buf, xfer))
</span><span style="color: #008080;">14</span>         r = -<span style="color: #000000;">EFAULT;
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">17</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span>mtp_read()会通过USB读取"PC发给Android设备的请求"，获取到请求后，会通过copy_to_user()会将数据从"内核空间"拷贝到"用户空间"，这样用户就能在用户空间读取到该数据。</p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">三. mtp_write()</span></h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> ssize_t mtp_write(<span style="color: #0000ff;">struct</span> file *fp, <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> __user *<span style="color: #000000;">buf,
</span><span style="color: #008080;"> 2</span>     size_t count, loff_t *<span style="color: #000000;">pos)
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">while</span> (count &gt; <span style="color: #800080;">0</span> ||<span style="color: #000000;"> sendZLP) {
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将“用户空间”传来的消息(buf)拷贝到“内核空间”的req-&gt;buf中。</span>
<span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span> (xfer &amp;&amp; copy_from_user(req-&gt;<span style="color: #000000;">buf, buf, xfer)) 
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将打包好的消息req放到USB消息队列中。</span>
<span style="color: #008080;">12</span>         ret = usb_ep_queue(dev-&gt;<span style="color: #000000;">ep_in, req, GFP_KERNEL);
</span><span style="color: #008080;">13</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">17</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><strong>说明</strong>：mtp_write()会将"用户空间"发来的消息拷贝到"内核空间"，并将该消息打包；然后，将打包好的消息添加到USB消息队列中。USB驱动负责将消息队列中的消息传递给PC。</p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">10 mServer.start()</span></h1>
<p><span style="font-size: 14px;">MtpServer实际上是一个Runnable线程接口。在"MtpReceiver的handleUsbState()"中，初始化MtpServer之后，会启动MtpServer。</span></p>
<p><span style="font-size: 14px;">MtpServer中的run()方法如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">@Override
</span><span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {
    native_run();
    native_cleanup();
}</span></pre>
</div>
<p><span style="font-size: 14px;">从中，我们发现run()实际上是调用的本地方法native_run()。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">10.1 native_run()</span></h2>
<p><span style="font-size: 14px;">根据前面的gMethods表格，我们知道native_run()对应JNI层的android_mtp_MtpServer_run()方法，它的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> android_mtp_MtpServer_run(JNIEnv *<span style="color: #000000;">env, jobject thiz)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 返回MtpServer对象</span>
<span style="color: #008080;"> 4</span>     MtpServer* server =<span style="color: #000000;"> getMtpServer(env, thiz);
</span><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 如果server不为NULL，则调用它的run()方法。</span>
<span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (server)
</span><span style="color: #008080;"> 7</span>         server-&gt;<span style="color: #000000;">run();
</span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;"> 9</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">server is null in run</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">10</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">(01) getMtpServer()返回的是MtpServer对象。这个前面已经介绍过！</span></p>
<p><span style="font-size: 14px;">(02) 调用MtpServer对象的run()方法。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">10.2 run()</span></h2>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpServer::run() {
</span><span style="color: #008080;"> 2</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将mFD赋值给fd，fd就是“/dev/mtp_usb”的句柄</span>
<span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">int</span> fd =<span style="color: #000000;"> mFD;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">while</span> (<span style="color: #800080;">1</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 读取“/dev/mtp_usb”</span>
<span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">int</span> ret =<span style="color: #000000;"> mRequest.read(fd);
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“MTP操作码”</span>
<span style="color: #008080;">11</span>         MtpOperationCode operation =<span style="color: #000000;"> mRequest.getOperationCode();
</span><span style="color: #008080;">12</span>         MtpTransactionID transaction =<span style="color: #000000;"> mRequest.getTransactionID();
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 在handleRequest()中，根据读取的指令作出相应的处理</span>
<span style="color: #008080;">17</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (handleRequest()) {
</span><span style="color: #008080;">18</span> <span style="color: #000000;">            ...
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">23</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">run()会不断的从"/dev/mtp_usb"中读取数据。如果是有效的指令，则在handleRequest()作出相应的处理。</span></p>
<p><span style="font-size: 14px;">(01) mRequest是MtpRequestPacket对象，MtpRequestPacket是解析"PC请求指令"的类。</span></p>
<p><span style="font-size: 14px;">(02) handleRequest()是具体处理"MTP各个指令的类"。例如，PC获取Android设备的设备信息指令，是在handleRequest()中处理的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h2><span style="font-size: 14px;">10.3 while(1){...}</span></h2>
<p><span style="font-size: 14px;">在run()中，会通过while(1)循环不断的"执行read()，从"/dev/mtp_usb中读取数据"；然后调用handleRequest()对数据进行处理"。</span></p>
<p><span style="font-size: 14px;">read()函数最终会调用到Kernel的mtp_read()，mtp_read()已经在前面介绍过了。</span></p>
<p><span style="font-size: 14px;">handleRequest()则是对读取出来的消息进行处理，它的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">bool</span><span style="color: #000000;"> MtpServer::handleRequest() {
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    Mutex::Autolock autoLock(mMutex);
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span>     MtpOperationCode operation =<span style="color: #000000;"> mRequest.getOperationCode();
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    MtpResponseCode response;
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span> <span style="color: #000000;">    mResponse.reset();
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">if</span> (mSendObjectHandle != kInvalidObjectHandle &amp;&amp; operation !=<span style="color: #000000;"> MTP_OPERATION_SEND_OBJECT) {
</span><span style="color: #008080;">10</span>         mSendObjectHandle =<span style="color: #000000;"> kInvalidObjectHandle;
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (operation) {
</span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_OPERATION_GET_DEVICE_INFO:
</span><span style="color: #008080;">15</span>             response =<span style="color: #000000;"> doGetDeviceInfo();
</span><span style="color: #008080;">16</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_OPERATION_OPEN_SESSION:
</span><span style="color: #008080;">18</span>             response =<span style="color: #000000;"> doOpenSession();
</span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_OPERATION_CLOSE_SESSION:
</span><span style="color: #008080;">21</span>             response =<span style="color: #000000;"> doCloseSession();
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">23</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">24</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_OPERATION_GET_OBJECT:
</span><span style="color: #008080;">25</span>             response =<span style="color: #000000;"> doGetObject();
</span><span style="color: #008080;">26</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_OPERATION_SEND_OBJECT:
</span><span style="color: #008080;">28</span>             response =<span style="color: #000000;"> doSendObject();
</span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">30</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span>     <span style="color: #0000ff;">if</span> (response ==<span style="color: #000000;"> MTP_RESPONSE_TRANSACTION_CANCELLED)
</span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">false</span><span style="color: #000000;">;
</span><span style="color: #008080;">35</span> <span style="color: #000000;">    mResponse.setResponseCode(response);
</span><span style="color: #008080;">36</span>     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;
</span><span style="color: #008080;">37</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p>&nbsp;</p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-family: 楷体; font-size: 14px;"><strong>总结</strong>：
在"PC和Android设备"连接后，MtpReceiver会收到广播。接着MtpReceiver会启动
MtpService，MtpService会启动MtpServer(Java层)。MtpServer(Java)层会调用底层的JNI函数。在
JNI中，会打开MTP文件节点"/dev/mtp_usb"，然后MtpServer(JNI层)会不断的从中读取消息并进行处理。 </span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;"><a name="part4"></a>第4部分 MTP协议之I-&gt;R流程</span></h3>
<p><span style="font-size: 14px;">下面以"PC中打开一个MTP上的文件(读取文件内容)"来对"MTP协议中Initiator到Reponser的流程"进行说明。PC读取文件内容的时序图如图4-01所示：</span></p>
<p style="text-align: center;"><a href="http://images.cnitblog.com/blog/497634/201312/14135926-d6bd71d9f3384fcf85706e4dc823c3e0.jpg" target="_blank"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135926-d6bd71d9f3384fcf85706e4dc823c3e0.jpg" alt="" height="419" width="640"></span></a></p>
<p style="text-align: center;"><span style="font-size: 14px;">图4-01</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">1 read()</span></h1>
<p><span style="font-size: 14px;">根据MTP启动流程中分析可知： MTP启动后，MtpServer.cpp中的MtpServer::run()会通过read()不断地从"/dev/mtp_usb"中读取出"PC发来的消息"。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">2 handleRequest()</span></h1>
<p><span style="font-size: 14px;">read()在读取到PC来的消息之后，会交给MtpServer::handleRequest()进行处理。"PC读取文件内容"的消息的ID是MTP_OPERATION_GET_OBJECT；因此，它会通过doGetObject()进行处理。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">3. doGetObject()</span></h1>
<p><span style="font-size: 14px;">MtpServer.cpp中doGetObject()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">MtpResponseCode MtpServer::doGetObject() {
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 3</span>     
<span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 根据handle获取文件的路径(pathBuf)、大小(fileLength)和“格式”。</span>
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">int</span> result = mDatabase-&gt;<span style="color: #000000;">getObjectFilePath(handle, pathBuf, fileLength, format);
</span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">if</span> (result !=<span style="color: #000000;"> MTP_RESPONSE_OK)
</span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将文件路径转换为const char*类型。</span>
<span style="color: #008080;">10</span>     <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span>* filePath = (<span style="color: #0000ff;">const</span> <span style="color: #0000ff;">char</span> *<span style="color: #000000;">)pathBuf;
</span><span style="color: #008080;">11</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将文件的信息传递给mfr，mfr是kernel的一个结构体；最终将mfr传递给kernel。</span>
<span style="color: #008080;">12</span> <span style="color: #000000;">    mtp_file_range  mfr;
</span><span style="color: #008080;">13</span>     mfr.fd = open(filePath, O_RDONLY);                 <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“文件句柄”。</span>
<span style="color: #008080;">14</span>     <span style="color: #0000ff;">if</span> (mfr.fd &lt; <span style="color: #800080;">0</span><span style="color: #000000;">) {
</span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> MTP_RESPONSE_GENERAL_ERROR;
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">17</span>     mfr.offset = <span style="color: #800080;">0</span>;                                    <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“文件偏移”</span>
<span style="color: #008080;">18</span>     mfr.length =<span style="color: #000000;"> fileLength;
</span><span style="color: #008080;">19</span>     mfr.command = mRequest.getOperationCode();         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“command”</span>
<span style="color: #008080;">20</span>     mfr.transaction_id = mRequest.getTransactionID();  <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“transaction ID”
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 通过ioctl将文件传给kernel。</span>
<span style="color: #008080;">23</span>     <span style="color: #0000ff;">int</span> ret = ioctl(mFD, MTP_SEND_FILE_WITH_HEADER, (unsigned <span style="color: #0000ff;">long</span>)&amp;<span style="color: #000000;">mfr);
</span><span style="color: #008080;">24</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 关闭文件</span>
<span style="color: #008080;">25</span> <span style="color: #000000;">    close(mfr.fd);
</span><span style="color: #008080;">26</span> 
<span style="color: #008080;">27</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">28</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">doGetDeviceInfo的流程就是，先通过JNI回调Java中的函数，
(根据文件句柄)从MediaProvider数据库中获取文件的路径、大小和格式等信息。接着，将这些信息封装到kernel
的"mtp_file_range结构体"中。最后，通过ioctl将"mtp_file_range结构体"传递给kernel。这样，kernel就
收到文件的相关信息了，kernel负责将文件信息通过USB协议传递给PC。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">4 getObjectFilePath()</span></h1>
<p><span style="font-size: 14px;">doGetObject()会调用的getObjectFilePath()。该函数在android_mtp_MtpDatabase.cpp中实现。</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">MtpResponseCode MyMtpDatabase::getObjectFilePath(MtpObjectHandle handle,
</span><span style="color: #008080;"> 2</span>                                             MtpString&amp;<span style="color: #000000;"> outFilePath,
</span><span style="color: #008080;"> 3</span>                                             int64_t&amp;<span style="color: #000000;"> outFileLength,
</span><span style="color: #008080;"> 4</span>                                             MtpObjectFormat&amp;<span style="color: #000000;"> outFormat) {
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 6</span> 
<span style="color: #008080;"> 7</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 调用MtpDatabase.java中的getObjectFilePath()。
</span><span style="color: #008080;"> 8</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 作用是根据文件句柄，获取“文件路径”、“文件大小”、“文件格式”</span>
<span style="color: #008080;"> 9</span>     jint result = env-&gt;<span style="color: #000000;">CallIntMethod(mDatabase, method_getObjectFilePath,
</span><span style="color: #008080;">10</span> <span style="color: #000000;">                (jint)handle, mStringBuffer, mLongBuffer);
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“文件路径”</span>
<span style="color: #008080;">13</span>     jchar* str = env-&gt;GetCharArrayElements(mStringBuffer, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    outFilePath.setTo(str, strlen16(str));
</span><span style="color: #008080;">15</span>     env-&gt;ReleaseCharArrayElements(mStringBuffer, str, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 设置“文件大小”和“文件格式”</span>
<span style="color: #008080;">18</span>     jlong* longValues = env-&gt;GetLongArrayElements(mLongBuffer, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">19</span>     outFileLength = longValues[<span style="color: #800080;">0</span><span style="color: #000000;">];
</span><span style="color: #008080;">20</span>     outFormat = longValues[<span style="color: #800080;">1</span><span style="color: #000000;">];
</span><span style="color: #008080;">21</span>     env-&gt;ReleaseLongArrayElements(mLongBuffer, longValues, <span style="color: #800080;">0</span><span style="color: #000000;">);
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span> 
<span style="color: #008080;">24</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">25</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：</span></p>
<p><span style="font-size: 14px;">MyMtpDatabase::getObjectFilePath()实际上通过MtpDatabase.java中的getObjectFilePath()来获取文件的相关信息的。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">5 getObjectFilePath()</span></h1>
<p><span style="font-size: 14px;">MtpDatabase.java中getObjectFilePath()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> getObjectFilePath(<span style="color: #0000ff;">int</span> handle, <span style="color: #0000ff;">char</span>[] outFilePath, <span style="color: #0000ff;">long</span><span style="color: #000000;">[] outFileLengthFormat) {
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在MediaProvider中查找文件对应的路径。
</span><span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> mObjectsUri是根据文件handle获取到的URI。</span>
<span style="color: #008080;"> 6</span>     c =<span style="color: #000000;"> mMediaProvider.query(mPackageName, mObjectsUri, PATH_FORMAT_PROJECTION,
</span><span style="color: #008080;"> 7</span>                     ID_WHERE, <span style="color: #0000ff;">new</span> String[] {  Integer.toString(handle) }, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">if</span> (c != <span style="color: #0000ff;">null</span> &amp;&amp;<span style="color: #000000;"> c.moveToNext()) {
</span><span style="color: #008080;"> 9</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“文件路径”</span>
<span style="color: #008080;">10</span>         String path = c.getString(1<span style="color: #000000;">);
</span><span style="color: #008080;">11</span>         path.getChars(0, path.length(), outFilePath, 0<span style="color: #000000;">);
</span><span style="color: #008080;">12</span>         outFilePath[path.length()] = 0<span style="color: #000000;">;
</span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“文件大小”</span>
<span style="color: #008080;">14</span>         outFileLengthFormat[0] = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(path).length();
</span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取“文件格式”</span>
<span style="color: #008080;">16</span>         outFileLengthFormat[1] = c.getLong(2<span style="color: #000000;">);
</span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> MtpConstants.RESPONSE_OK;
</span><span style="color: #008080;">18</span>     } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;">19</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> MtpConstants.RESPONSE_INVALID_OBJECT_HANDLE;
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">21</span> 
<span style="color: #008080;">22</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">23</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：getObjectFilePath()会从MediaProvider的数据库中查找相应的文件，从而获取文件信息。然后，将文件的信息回传给JNI。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">6 ioctl</span></h1>
<p><span style="font-size: 14px;">MtpServer.cpp中doGetObject()中获取到文件信息之后，会通过ioctl将</span>MTP_SEND_FILE_WITH_HEADER消息传递给Kernel。</p>
<p><span style="font-size: 14px;">根据前面介绍的Kernel内容克制，ioctl在file_operations中注册，ioctl实际上会执行mtp_ioctl()函数。它的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">long</span> mtp_ioctl(<span style="color: #0000ff;">struct</span> file *fp, unsigned code, unsigned <span style="color: #0000ff;">long</span><span style="color: #000000;"> value)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (code) {
</span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_SEND_FILE:
</span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_RECEIVE_FILE:
</span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_SEND_FILE_WITH_HEADER:
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    {
</span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">struct</span><span style="color: #000000;"> mtp_file_range    mfr;
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">struct</span> work_struct *<span style="color: #000000;">work;
</span><span style="color: #008080;">12</span> 
<span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将“用户空间”传来的值(value)拷贝到“内核空间”的mfr中。</span>
<span style="color: #008080;">14</span>         <span style="color: #0000ff;">if</span> (copy_from_user(&amp;mfr, (<span style="color: #0000ff;">void</span> __user *)value, <span style="color: #0000ff;">sizeof</span><span style="color: #000000;">(mfr))) {
</span><span style="color: #008080;">15</span>             ret = -<span style="color: #000000;">EFAULT;
</span><span style="color: #008080;">16</span>             <span style="color: #0000ff;">goto</span><span style="color: #000000;"> fail;
</span><span style="color: #008080;">17</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取文件句柄</span>
<span style="color: #008080;">19</span>         filp =<span style="color: #000000;"> fget(mfr.fd);
</span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">filp) {
</span><span style="color: #008080;">21</span>             ret = -<span style="color: #000000;">EBADF;
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">goto</span><span style="color: #000000;"> fail;
</span><span style="color: #008080;">23</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将“文件相关的信息”赋值给dev。</span>
<span style="color: #008080;">26</span>         dev-&gt;xfer_file =<span style="color: #000000;"> filp;
</span><span style="color: #008080;">27</span>         dev-&gt;xfer_file_offset =<span style="color: #000000;"> mfr.offset;
</span><span style="color: #008080;">28</span>         dev-&gt;xfer_file_length =<span style="color: #000000;"> mfr.length;
</span><span style="color: #008080;">29</span> <span style="color: #000000;">        smp_wmb();
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span>         <span style="color: #0000ff;">if</span> (code ==<span style="color: #000000;"> MTP_SEND_FILE_WITH_HEADER) {
</span><span style="color: #008080;">32</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 设置work的值</span>
<span style="color: #008080;">33</span>             work = &amp;dev-&gt;<span style="color: #000000;">send_file_work;
</span><span style="color: #008080;">34</span>             dev-&gt;xfer_send_header = <span style="color: #800080;">1</span><span style="color: #000000;">;
</span><span style="color: #008080;">35</span>             dev-&gt;xfer_command =<span style="color: #000000;"> mfr.command;
</span><span style="color: #008080;">36</span>             dev-&gt;xfer_transaction_id =<span style="color: #000000;"> mfr.transaction_id;
</span><span style="color: #008080;">37</span> <span style="color: #000000;">        } 
</span><span style="color: #008080;">38</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">39</span> 
<span style="color: #008080;">40</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将work添加到工作队列(dev-&gt;wq)中。</span>
<span style="color: #008080;">41</span>         queue_work(dev-&gt;<span style="color: #000000;">wq, work);
</span><span style="color: #008080;">42</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 对工作队列执行flush操作。</span>
<span style="color: #008080;">43</span>         flush_workqueue(dev-&gt;<span style="color: #000000;">wq);
</span><span style="color: #008080;">44</span> 
<span style="color: #008080;">45</span>         <span style="color: #0000ff;">break</span><span style="color: #000000;">;
</span><span style="color: #008080;">46</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">47</span> 
<span style="color: #008080;">48</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">49</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：mtp_ioctl()在收到
MTP_SEND_FILE_WITH_HEADER消息之后，会获取文件相关信息。然后将"work"添加到工作队列dev-&gt;wq中进行调度。
work对应的函数指针是send_file_work()函数；这就意味着，工作队列会制定send_file_work()函数。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">send_file_work()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> send_file_work(<span style="color: #0000ff;">struct</span> work_struct *<span style="color: #000000;">data)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获取dev结构体</span>
<span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">struct</span> mtp_dev *dev = container_of(data, <span style="color: #0000ff;">struct</span><span style="color: #000000;"> mtp_dev,
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                        send_file_work);
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 读取文件消息</span>
<span style="color: #008080;"> 9</span> <span style="color: #000000;">    smp_rmb();
</span><span style="color: #008080;">10</span>     filp = dev-&gt;<span style="color: #000000;">xfer_file;
</span><span style="color: #008080;">11</span>     offset = dev-&gt;<span style="color: #000000;">xfer_file_offset;
</span><span style="color: #008080;">12</span>     count = dev-&gt;<span style="color: #000000;">xfer_file_length;
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span>     <span style="color: #0000ff;">while</span> (count &gt; <span style="color: #800080;">0</span> ||<span style="color: #000000;"> sendZLP) {
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 从文件中读取数据到内存中。</span>
<span style="color: #008080;">20</span>         ret = vfs_read(filp, req-&gt;buf + hdr_size, xfer -<span style="color: #000000;"> hdr_size,
</span><span style="color: #008080;">21</span>                                 &amp;<span style="color: #000000;">offset);
</span><span style="color: #008080;">22</span> 
<span style="color: #008080;">23</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">24</span> 
<span style="color: #008080;">25</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将req添加到usb终端的队列中</span>
<span style="color: #008080;">26</span>         ret = usb_ep_queue(dev-&gt;<span style="color: #000000;">ep_in, req, GFP_KERNEL);
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">29</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">30</span> 
<span style="color: #008080;">31</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">32</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：send_file_work()的作用就是不断地将文件中的数据读取到内存中，并封装到USB请求结构体req中。然后，再将数据req传递到USB工作队列，USB赋值将文件内容传递给PC。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">至此，PC读取文件内容的流程分析完毕！</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h3><span style="font-family: 黑体; font-size: 18pt; line-height: 1.5;"><a name="part5"></a>第5部分 MTP协议之R-&gt;I流程</span></h3>
<p><span style="font-size: 14px;">下面以"Android设备中将一个文件拷贝到其他目录"来对"MTP协议中Reponser到Initiator的流程"进行说明。对应的时序图如图5-01所示：</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p style="text-align: center;"><a href="http://images.cnitblog.com/blog/497634/201312/14135927-a570b9e685b14c379a0b34d0733b4bb2.jpg" target="_blank"><span style="font-size: 14px;"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/14135927-a570b9e685b14c379a0b34d0733b4bb2.jpg" alt="" height="298" width="770"></span></a></p>
<p style="text-align: center;"><span style="font-size: 14px;">图5-01</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">1 MediaProvider.java中sendObjectAdded()</span></h1>
<p><span style="font-size: 14px;">在Android设备上将一个文件拷贝到其他目录。文件浏览器中会发出一个Intent事件，通知MediaProvider更新数据库。MediaProvider更新了数据库之后，会通知MTP进行同步处理。MediaProvider通知MTP的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> sendObjectAdded(<span style="color: #0000ff;">long</span><span style="color: #000000;"> objectHandle) {
</span><span style="color: #008080;"> 2</span>     <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mMtpServiceConnection) {
</span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (mMtpService != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 5</span>                 mMtpService.sendObjectAdded((<span style="color: #0000ff;">int</span><span style="color: #000000;">)objectHandle);
</span><span style="color: #008080;"> 6</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RemoteException e) {
</span><span style="color: #008080;"> 7</span>                 Log.e(TAG, "RemoteException in sendObjectAdded"<span style="color: #000000;">, e);
</span><span style="color: #008080;"> 8</span>                 mMtpService = <span style="color: #0000ff;">null</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">10</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">12</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：该函数会通知MtpService，Android设备中新建了个文件。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">2 MtpService.java中sendObjectAdded()</span></h1>
<p><span style="font-size: 14px;">MtpService.java中sendObjectAdded()的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;">1</span> <span style="color: #000000;">MtpService.java中sendObjectAdded()的源码如下：
</span><span style="color: #008080;">2</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> sendObjectAdded(<span style="color: #0000ff;">int</span><span style="color: #000000;"> objectHandle) {
</span><span style="color: #008080;">3</span>     <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mBinder) {
</span><span style="color: #008080;">4</span>         <span style="color: #0000ff;">if</span> (mServer != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {
</span><span style="color: #008080;">5</span> <span style="color: #000000;">            mServer.sendObjectAdded(objectHandle);
</span><span style="color: #008080;">6</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">7</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">8</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：该函数会发送消息给mServer，而mServer是MtpServer对象。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">3 MtpServer.java中的sendObjectAdded</span></h1>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> sendObjectAdded(<span style="color: #0000ff;">int</span><span style="color: #000000;"> handle) {
</span><span style="color: #008080;">2</span> <span style="color: #000000;">    native_send_object_added(handle);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：该函数会调研JNI本地方法。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">4&nbsp;</span><span style="font-size: 14px;">native_send_object_added()</span></h1>
<p><span style="font-size: 14px;">native_send_object_added()在
android_mtp_MtpServer.cpp中实现。根据前面介绍相关内容可知，native_send_object_added()和
android_mtp_MtpServer_send_object_added()对应。后者的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> android_mtp_MtpServer_send_object_added(JNIEnv *<span style="color: #000000;">env, jobject thiz, jint handle)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    Mutex::Autolock autoLock(sMutex);
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 获取MtpServer，然后调用MtpServer的sendObjectAdded()方法。</span>
<span style="color: #008080;"> 6</span>     MtpServer* server =<span style="color: #000000;"> getMtpServer(env, thiz);
</span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (server)
</span><span style="color: #008080;"> 8</span>         server-&gt;<span style="color: #000000;">sendObjectAdded(handle);
</span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">else</span>
<span style="color: #008080;">10</span>         ALOGE(<span style="color: #800000;">"</span><span style="color: #800000;">server is null in send_object_added</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;">11</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：该函数会将消息发送给MtpServer。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">5 MtpServer.cpp中的sendObjectAdded</span></h1>
<p><span style="font-size: 14px;">MtpServer.cpp中sendObjectAdded()的源码如下：</span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> MtpServer::sendObjectAdded(MtpObjectHandle handle) {
</span><span style="color: #008080;">2</span> <span style="color: #000000;">    sendEvent(MTP_EVENT_OBJECT_ADDED, handle);
</span><span style="color: #008080;">3</span> }</pre>
</div>
<p><span style="font-size: 14px;"><strong>说明</strong>：sendEvent()的作用，我们前面已经介绍过了。它在此处的目的，就是通过ioctl将消息发送给Kernel。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">6 Kernel中的ioctl</span></h1>
<p><span style="font-size: 14px;">在Kernel中，ioctl消息会调用mtp_ioctl()进行处理。它的源码如下：</span></p>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">long</span> mtp_ioctl(<span style="color: #0000ff;">struct</span> file *fp, unsigned code, unsigned <span style="color: #0000ff;">long</span><span style="color: #000000;"> value)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">case</span><span style="color: #000000;"> MTP_SEND_EVENT:
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    {
</span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">struct</span> mtp_event    <span style="color: #0000ff;">event</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 将“用户空间”传来的值(value)拷贝到“内核空间”的event中。</span>
<span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span> (copy_from_user(&amp;<span style="color: #0000ff;">event</span>, (<span style="color: #0000ff;">void</span> __user *)value, <span style="color: #0000ff;">sizeof</span>(<span style="color: #0000ff;">event</span><span style="color: #000000;">)))
</span><span style="color: #008080;">10</span>             ret = -<span style="color: #000000;">EFAULT;
</span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">else</span>
<span style="color: #008080;">12</span>             ret = mtp_send_event(dev, &amp;<span style="color: #0000ff;">event</span><span style="color: #000000;">);
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> <span style="color: #000000;">        ...
</span><span style="color: #008080;">15</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">16</span>     
<span style="color: #008080;">17</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">18</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：对于MTP_SEND_EVENT消息，mtp_ioctl会先将"用户空间"传递来的消息拷贝到"内核空间"；然后，调用mtp_send_event()进行处理。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<h1><span style="font-size: 14px;">7 Kernel中的mtp_send_event()</span></h1>
<div class="cnblogs_code"><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div>
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> mtp_send_event(<span style="color: #0000ff;">struct</span> mtp_dev *dev, <span style="color: #0000ff;">struct</span> mtp_event *<span style="color: #0000ff;">event</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">{
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将“用户空间”传来的“消息的内容(event-&gt;data)”拷贝到“内核空间”中</span>
<span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">if</span> (copy_from_user(req-&gt;buf, (<span style="color: #0000ff;">void</span> __user *)<span style="color: #0000ff;">event</span>-&gt;<span style="color: #000000;">data, length)) 
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;"> 8</span> 
<span style="color: #008080;"> 9</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 将req请求添加到USB队列中。</span>
<span style="color: #008080;">10</span>     ret = usb_ep_queue(dev-&gt;<span style="color: #000000;">ep_intr, req, GFP_KERNEL);
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span> <span style="color: #000000;">    ...
</span><span style="color: #008080;">13</span> }</pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a href="javascript:void(0);" onclick="copyCnblogsCode(this)" title="复制代码"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/copycode.gif" alt="复制代码"></a></span></div></div>
<p><span style="font-size: 14px;"><strong>说明</strong>：mtp_send_event()会先将"用户空间"传递来的消息的具体内容拷贝到"内核空间"，并将该消息封装在一个USB请求对象req中；然后，将USB请求添加到USB队列中。USB驱动负责将该数据通过USB线发送给PC。</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">至此，Android设备中将一个文件拷贝到其他目录的流程分析完毕！</span></p></div><div id="MySignature"><table><tbody><tr><td><img style="width: 80px; height:80px;" src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/t_f1.jpg" alt="img"></td><td style="FONT-WEIGHT: normal; FONT-SIZE: 14pt; LINE-HEIGHT: 100%; FONT-STYLE: normal; FONT-VARIANT: normal; color:#FF0000"><font style="LINE-HEIGHT: 250%; FONT-SIZE:14pt; color:#610B21">生活的悲欢离合永远在地平线以外，而眺望是一种青春的姿态...</font><br>PS.文章是笔者分享的学习笔记，若你觉得可以、还行、过得去、甚至不太差的话，可以“推荐”一下的哦。就此谢过!</td></tr></tbody></table></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="blog_post_info"><div id="BlogPostCategory">分类: <a href="http://www.cnblogs.com/skywang12345/category/490118.html">Android 系统层</a></div>
<div id="EntryTag">标签: <a href="http://www.cnblogs.com/skywang12345/tag/android/">android</a>, <a href="http://www.cnblogs.com/skywang12345/tag/%E8%AF%A6%E8%A7%A3/">详解</a>, <a href="http://www.cnblogs.com/skywang12345/tag/%E6%A1%86%E6%9E%B6/">框架</a>, <a href="http://www.cnblogs.com/skywang12345/tag/%E6%B5%81%E7%A8%8B/">流程</a>, <a href="http://www.cnblogs.com/skywang12345/tag/MTP/">MTP</a>, <a href="http://www.cnblogs.com/skywang12345/tag/%E8%AF%B4%E6%98%8E/">说明</a>, <a href="http://www.cnblogs.com/skywang12345/tag/%E8%A7%84%E6%A0%BC/">规格</a></div>
<div id="green_channel">
绿色通道：
<a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(cb_entryId,cb_blogId,1);green_channel_success(this,'谢谢推荐！');">好文要顶</a>
<a id="green_channel_follow" onclick="c_follow();" href="javascript:void(0);">关注我</a>
<a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a><a id="green_channel_contact" href="http://space.cnblogs.com/msg/send/%e5%a6%82%e6%9e%9c%e5%a4%a9%e7%a9%ba%e4%b8%8d%e6%ad%bb" target="_blank">与我联系</a>
<a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/icon_weibo_24.png" alt=""></a>
</div>
<div id="digg_block">
<div id="author_profile">
<div id="author_profile_info" class="author_profile_info">
<a href="http://home.cnblogs.com/u/skywang12345/" target="_blank"><img src="Android%E4%B9%8B%20MTP%E6%A1%86%E6%9E%B6%E5%92%8C%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%20-%20%E5%A6%82%E6%9E%9C%E5%A4%A9%E7%A9%BA%E4%B8%8D%E6%AD%BB%20-%20%E5%8D%9A%E5%AE%A2%E5%9B%AD_files/20131015182802.jpeg" class="author_avatar" alt=""></a>
<div id="author_profile_detail" class="author_profile_info">
<a href="http://home.cnblogs.com/u/skywang12345/">如果天空不死</a><br>
<a href="http://home.cnblogs.com/u/skywang12345/followees">关注 - 9</a><br>
<a href="http://home.cnblogs.com/u/skywang12345/followers">粉丝 - 226</a>
</div>
</div>
<div class="clear"></div>
<div id="author_profile_honor"></div>
<div id="author_profile_follow">
<a href="javascript:void(0);" onclick="c_follow();return false;">+加关注</a>
</div>
</div>
<div id="div_digg">										
	<div class="diggit" onclick="votePost(cb_entryId,'Digg')"> 
		<span class="diggnum" id="digg_count">2</span>
	</div>
	<div class="buryit" onclick="votePost(cb_entryId,'Bury')"> 
		<span class="burynum" id="bury_count">0</span>
	</div>
	<div class="clear"></div>	
	<div class="diggword" id="digg_tips">
    (请您对文章做出评价)
    </div>	
</div>
</div></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/skywang12345/p/3470728.html" class="p_n_p_prefix">« </a> 上一篇：<a href="http://www.cnblogs.com/skywang12345/p/3470728.html" title="发布于2013-12-12 12:24">FreeCommander 学习手册</a><br><a href="http://www.cnblogs.com/skywang12345/p/3479024.html" class="p_n_p_prefix">» </a> 下一篇：<a href="http://www.cnblogs.com/skywang12345/p/3479024.html" title="发布于2014-01-09 22:38">Java多线程系列--“基础篇”01之 基本概念</a><br></div>
</div>


    </div>
	<div class="itemdesc">
		posted on <span id="post-date">2013-12-15 10:11</span> <a href="http://www.cnblogs.com/skywang12345/">如果天空不死</a> 阅读(<span id="post_view_count">1786</span>) 评论(<span id="post_comment_count">0</span>)  <a href="http://i.cnblogs.com/EditPosts.aspx?postid=3474206" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(3474206);return false;">收藏</a>
	</div>
</div>
	<script type="text/javascript">var allowComments=true,isLogined=false,cb_blogId=142383,cb_entryId=3474206,cb_blogApp=currentBlogApp,cb_blogUserGuid='529b107b-d87b-e211-aa8f-842b2b196315',cb_entryCreatedDate='2013/12/15 10:11:00';loadViewCount(cb_entryId);</script>
	
<a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login('commentform');">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="程序员的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="ad_under_post_holder">

<div id="google_ad_c1" class="c_ad_block">
    <!-- cnblogs_blogpost_C1_sitehome -->
    <div id="div-gpt-ad-1346480159711-0" style="width: 300px; height: 250px;">
    
    <div style="border: 0pt none;" id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__container__"><iframe src="javascript:&quot;<html><body style='background:transparent'></body></html>&quot;" style="border: 0px none; vertical-align: bottom;" marginheight="0" marginwidth="0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" frameborder="0" height="250" scrolling="no" width="300"></iframe></div><iframe src="javascript:&quot;<html><body style='background:transparent'></body></html>&quot;" style="border: 0px none; vertical-align: bottom; visibility: hidden; display: none;" marginheight="0" marginwidth="0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" frameborder="0" height="0" scrolling="no" width="0"></iframe></div>
</div>
<div id="blog_news_kb"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="http://news.cnblogs.com/n/207750/" target="_blank">森海塞尔携手谷歌开发模块化手机Project Ara</a><br> ·  <a href="http://news.cnblogs.com/n/207749/" target="_blank">苹果缩短在线购物退货时间 以期吸引更多消费者</a><br> ·  <a href="http://news.cnblogs.com/n/207748/" target="_blank">微信之父张小龙：产品经理的必备书单</a><br> ·  <a href="http://news.cnblogs.com/n/207747/" target="_blank">世界上10个最戒备森严的地方 千万别乱闯！</a><br> ·  <a href="http://news.cnblogs.com/n/207746/" target="_blank">Microsoft为移动推送新增了云身份认证服务部分</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/207490/" target="_blank">我的成长磨练：每天写博客</a><br> ·  <a href="http://kb.cnblogs.com/page/125434/" target="_blank">虚拟化——互联网时代的产品开发加速器</a><br> ·  <a href="http://kb.cnblogs.com/page/156124/" target="_blank">从技术到管理：思维转变是关键</a><br> ·  <a href="http://kb.cnblogs.com/page/128974/" target="_blank">年轻人，卷起袖子，来把手弄脏吧!</a><br> ·  <a href="http://kb.cnblogs.com/page/207086/" target="_blank">当随机不够随机：一个在线扑克游戏的教训</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div></div>
<script type="text/javascript">
var enableGoogleAd = true;
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
fixPostBodyFormat();
loadAdUnderPost();
</script>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
loadBlogSignature();
LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
</script>
<script type="text/javascript">
    $.ajax({ url: 'http://counter.cnblogs.com/blog/post/' + cb_entryId, type: 'get', dataType: 'script', cache: true });
</script>
</div>

        <div class="spacer">
            &nbsp;</div>
    </div>
    
<div class="footer">
	Powered by: 
	<br>
	
	<a id="Footer1_Hyperlink3" name="Hyperlink1" href="http://www.cnblogs.com/" style="font-family:Verdana;font-size:12px;">博客园</a>
	<br>
	Copyright © 如果天空不死
</div>
</div>



<iframe style="display: none; width: 0px; height: 0px;" name="google_osd_static_frame" id="google_osd_static_frame_1553810465687"></iframe></body></html>